<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PromptForge — Générateur de prompts IA</title>
<meta name="description" content="Crée des prompts IA performants en 3 champs. 35+ templates, bibliothèque, comparaison d'APIs, glossaire et bonnes pratiques.">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
:root {
  --bg:       #f8fafc;
  --bg-alt:   #ffffff;
  --s1:       #ffffff;
  --s2:       #f1f5f9;
  --s3:       #e2e8f0;
  --border:   #e2e8f0;
  --border2:  #cbd5e1;
  --text:     #0f172a;
  --muted:    #64748b;
  --soft:     #475569;
  --accent:   #2563eb;
  --accent-hover: #1d4ed8;
  --accent-light: #eff6ff;
  --accent2:   #6366f1;
  --warn:     #f59e0b;
  --danger:   #ef4444;
  --success:  #0d9488;
  --mono:     'JetBrains Mono', monospace;
  --ui:       'Outfit', sans-serif;
}
[data-theme="dark"] {
  --bg:       #0f172a;
  --bg-alt:   #1e293b;
  --s1:       #1e293b;
  --s2:       #334155;
  --s3:       #475569;
  --border:   #334155;
  --border2:  #475569;
  --text:     #f1f5f9;
  --muted:    #94a3b8;
  --soft:     #cbd5e1;
  --accent:   #60a5fa;
  --accent-hover: #93c5fd;
  --accent-light: #1e3a5f;
  --accent2:   #818cf8;
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
html { scroll-behavior:smooth; }
body {
  font-family:var(--ui); background:var(--bg); color:var(--text);
  min-height:100vh; line-height:1.65; transition:background-color 0.2s, color 0.2s;
  padding:1.5rem 2rem; /* Marge globale — rien ne touche les bords de l'écran */
}

/* ── ICONS ── */
.icon { width:1em; height:1em; vertical-align:middle; flex-shrink:0; }
.icon-sm { width:0.9em; height:0.9em; }

/* ── LAYOUT ── */
.container { position:relative; max-width:1300px; margin:0 auto; padding:0 3rem; }

/* ── HEADER ── */
header {
  padding:1.25rem 2.5rem;
  display:flex; align-items:center; justify-content:space-between;
  border:1px solid var(--border);
  border-radius:18px;
  background:var(--bg-alt);
  position:sticky; top:0; z-index:100;
}
.logo {
  display:flex; align-items:center; gap:0.6rem;
  font-size:1.1rem; font-weight:700; letter-spacing:-0.03em; color:var(--text);
}
.logo-icon {
  width:32px; height:32px; border-radius:12px;
  background:var(--accent); color:#fff;
  display:flex; align-items:center; justify-content:center;
}
.logo-icon svg { width:16px; height:16px; }
.header-tagline { font-size:0.7rem; color:var(--muted); font-weight:400; }
.header-nav { display:flex; gap:0.25rem; align-items:center; }
.header-nav-btn {
  font-family:var(--ui); font-size:0.85rem; font-weight:500;
  padding:0.6rem 1.1rem; border-radius:999px; cursor:pointer;
  border:1px solid var(--border); background:transparent; color:var(--soft);
  transition:all 0.15s; display:inline-flex; align-items:center; gap:0.4rem;
}
.header-nav-btn:hover { border-color:var(--border2); color:var(--text); }
.header-nav-btn.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.header-nav-btn:focus-visible, .btn:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible {
  outline:2px solid var(--accent); outline-offset:2px;
}

/* ── API CARDS ── */
.view-section { display:none; }
.view-section.active { display:block; }
.api-page { padding:2.5rem 0 5rem; }
.api-page .section-title {
  font-size:1.6rem; font-weight:800; letter-spacing:-0.03em; line-height:1.3;
  margin-bottom:0.75rem; color:var(--text);
}
.api-page .section-desc {
  font-size:0.95rem; color:var(--soft); margin-bottom:2.5rem; max-width:600px; line-height:1.7;
}
.api-grid {
  display:grid; grid-template-columns:repeat(auto-fill, minmax(380px, 1fr));
  gap:1.5rem;
}
.api-card {
  background:var(--s1); border:1px solid var(--border); border-radius:18px;
  overflow:hidden; transition:all 0.2s; box-shadow:0 1px 3px rgba(0,0,0,0.04);
}
.api-card:hover { border-color:var(--border2); box-shadow:0 4px 12px rgba(0,0,0,0.08); }
.api-card-header {
  padding:1.75rem 1.75rem 1.25rem;
  display:flex; align-items:center; gap:1.25rem;
}
.api-card-logo {
  width:52px; height:52px; border-radius:14px;
  display:flex; align-items:center; justify-content:center;
}
.api-card-title { font-size:1.15rem; font-weight:700; letter-spacing:-0.02em; }
.api-card-provider { font-size:0.72rem; color:var(--muted); margin-top:0.2rem; }
.api-card-desc {
  font-size:0.85rem; color:var(--soft); line-height:1.7;
  padding:0 1.75rem 1.5rem; margin-bottom:0.5rem; border-bottom:1px solid var(--border);
}
.api-card-models { padding:0 1.75rem 1.5rem; }
.api-models-legend {
  font-size:0.62rem; color:var(--muted); letter-spacing:0.06em; text-transform:uppercase;
  margin-bottom:0.6rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border);
}
.api-model-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:0.55rem 0; font-size:0.75rem; border-bottom:1px solid var(--border);
}
.api-model-row:last-child { border-bottom:none; }
.api-model-name { font-weight:600; color:var(--text); }
.api-model-price { font-family:var(--mono); font-size:0.7rem; color:var(--accent); }
.api-card-meta {
  padding:0 1.75rem 1.25rem; font-size:0.7rem; color:var(--muted);
}
.api-card-meta span { margin-right:1rem; }
.api-card-strengths {
  padding:0 1.75rem 1.5rem;
  font-size:0.72rem; color:var(--soft); line-height:1.6;
}
.api-card-strengths strong { color:var(--text); }
.api-card-link {
  display:inline-flex; align-items:center; gap:0.4rem;
  margin:1rem 1.75rem 1.5rem 1.75rem; font-size:0.72rem; font-weight:600; color:var(--accent);
  text-decoration:none; transition:color 0.15s;
}
.api-card-link:hover { color:var(--accent2); }
.api-badge {
  font-size:0.6rem; padding:0.15rem 0.5rem; border-radius:4px;
  font-weight:700; letter-spacing:0.05em; margin-left:0.5rem;
}
.api-badge.free { background:var(--accent-light); color:var(--accent); }
.api-badge.popular { background:var(--accent-light); color:var(--accent); }

/* ── API RECOMMENDER ── */
.api-recommender {
  background:var(--accent-light); border:1px solid var(--border); border-radius:16px;
  padding:2rem; margin-bottom:2.5rem;
}
.api-recommender h3 { font-size:1.05rem; margin-bottom:0.75rem; color:var(--text); line-height:1.4; }
.api-recommender p { font-size:0.9rem; color:var(--soft); margin-bottom:1.25rem; line-height:1.6; }
.api-recommender-row { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; }
.api-recommender-input {
  flex:1; min-width:200px; padding:0.9rem 1.25rem; background:var(--s2); border:1px solid var(--border);
  border-radius:12px; color:var(--text); font-family:var(--ui); font-size:0.95rem;
}
.api-recommender-input:focus { border-color:var(--accent); outline:none; }
.api-recommender-input::placeholder { color:var(--muted); }
.recommended-result { margin-top:1.5rem; }
.recommended-result .rec-title { font-size:0.82rem; font-weight:700; color:var(--accent); margin-bottom:0.75rem; text-transform:uppercase; letter-spacing:0.06em; }
.recommended-cards { display:flex; flex-direction:column; gap:1rem; }
.rec-card {
  background:var(--bg-alt); border:1px solid var(--border); border-radius:14px;
  padding:1.25rem 1.5rem; display:flex; align-items:flex-start; gap:1.25rem;
}
.rec-card-reason { font-size:0.85rem; color:var(--soft); margin-top:0.5rem; line-height:1.6; }

/* ── CONTENT PAGES ── */
.content-page { padding:2.5rem 0 5rem; max-width:900px; margin-left:auto; margin-right:auto; text-align:left; }
.content-page h2 { font-size:1.5rem; margin-bottom:1.25rem; margin-top:0.5rem; color:var(--text); line-height:1.3; display:flex; align-items:center; gap:0.5rem; }
.content-page h3 { font-size:1.05rem; margin:2rem 0 0.75rem; color:var(--soft); line-height:1.4; }
.content-page p, .content-page li { font-size:0.95rem; color:var(--soft); line-height:1.8; margin-bottom:1.25rem; }
.content-page ul { padding-left:1.5rem; margin-bottom:1.25rem; }
.bonnes-pratiques-encadre {
  background:var(--s1); border:1px solid var(--border); border-radius:16px;
  padding:2rem 2rem 2rem 2.25rem; margin-top:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.04);
}
.glossary-grid { display:grid; gap:1rem; }
.glossary-item {
  background:var(--s1); border:1px solid var(--border); border-radius:14px;
  padding:1.25rem 1.5rem; cursor:pointer; transition:all 0.15s;
  text-align:left;
}
.glossary-item:hover { border-color:var(--accent); background:var(--accent-light); }
.glossary-term { font-weight:700; color:var(--accent); font-size:0.95rem; margin-bottom:0.4rem; }
.glossary-def { font-size:0.88rem; color:var(--soft); line-height:1.7; }
.resource-card {
  background:var(--s1); border:1px solid var(--border); border-radius:14px;
  padding:1.25rem 1.5rem; margin-bottom:1rem; display:flex; align-items:flex-start; gap:1.25rem;
  transition:all 0.15s;
}
.resource-card:hover { border-color:var(--accent); }
.resource-card a { color:var(--accent); font-weight:600; text-decoration:none; }
.resource-card a:hover { color:var(--accent-hover); }
.snippet-chip {
  display:inline-block; font-size:0.75rem; padding:0.4rem 0.8rem;
  background:var(--s2); border:1px solid var(--border); border-radius:8px;
  cursor:pointer; margin:0.3rem; transition:all 0.15s;
}
.snippet-chip:hover { border-color:var(--accent); background:var(--accent-light); }
.lib-search { width:100%; margin-bottom:1.5rem; padding:1rem 1.5rem; background:var(--s2); border:1px solid var(--border); border-radius:14px; color:var(--text); }
.lib-search:focus { border-color:var(--accent); outline:none; }
.lib-actions { display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1.5rem; }
.lib-item {
  background:var(--s1); border:1px solid var(--border); border-radius:14px;
  padding:1.25rem 1.5rem; margin-bottom:0.75rem; display:flex; justify-content:space-between; align-items:flex-start; gap:1.25rem;
}
.lib-item-preview { font-size:0.8rem; color:var(--soft); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:400px; }
.lib-item-actions { display:flex; gap:0.3rem; }
.lib-item-actions button { background:none; border:none; cursor:pointer; font-size:1rem; padding:0.2rem; opacity:0.7; }
.lib-item-actions button:hover { opacity:1; color:var(--accent); }
.lib-star { color:var(--warn) !important; }
.comparison-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem; }
.comparison-box {
  background:var(--s2); border:1px solid var(--border); border-radius:14px;
  padding:1.25rem 1.5rem; min-height:120px;
}
.comparison-label { font-size:0.7rem; font-weight:700; color:var(--accent); margin-bottom:0.5rem; }
.var-hint { font-size:0.68rem; color:var(--muted); margin-top:0.3rem; }
.var-hint code { background:var(--s3); padding:0.1rem 0.4rem; border-radius:4px; }
.dropdown-nav { position:relative; }
.dropdown-nav .dropdown-menu {
  display:none; position:absolute; top:100%; right:0; margin-top:0.5rem;
  background:var(--s1); border:1px solid var(--border); border-radius:14px;
  padding:0.6rem; min-width:200px; z-index:50; box-shadow:0 8px 24px rgba(0,0,0,0.08);
}
.dropdown-nav.open .dropdown-menu { display:block; }
.dropdown-nav .dropdown-menu button {
  display:block; width:100%; text-align:left; padding:0.6rem 1rem;
  background:none; border:none; color:var(--text); font-family:var(--ui); font-size:0.88rem;
  cursor:pointer; border-radius:10px;
}
.dropdown-nav .dropdown-menu button:hover { background:var(--s2); color:var(--accent); }

/* ── MODE SIMPLE ── */
.mode-toggle { display:flex; gap:0.5rem; align-items:center; }
.mode-btn { font-size:0.85rem; padding:0.5rem 1.1rem; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; transition:all 0.15s; min-width:90px; justify-content:center; }
.mode-btn:hover { color:var(--text); }
.mode-btn.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.advanced-block { overflow:hidden; transition:max-height 0.4s ease; max-height:1200px; }
.advanced-block.collapsed { max-height:0 !important; opacity:0; pointer-events:none; margin:0 !important; padding:0 !important; }
.advanced-block-inner { display:contents; }
.advanced-toggle {
  display:flex; align-items:center; gap:0.6rem; font-size:0.85rem; color:var(--accent); cursor:pointer;
  margin:1.5rem 0 0.9rem; padding:0.7rem 0; user-select:none;
}
.advanced-toggle:hover { color:var(--accent-hover); }
.advanced-toggle .arrow { transition:transform 0.2s; font-size:0.7rem; }
.advanced-toggle.expanded .arrow { transform:rotate(90deg); }
.tip-card.collapsible .tip-body { transition:max-height 0.3s ease, opacity 0.2s; overflow:hidden; max-height:500px; }
.tip-card.collapsible.collapsed .tip-body { max-height:0 !important; opacity:0; }
.tip-toggle { font-size:0.7rem; color:var(--accent); cursor:pointer; margin-top:0.5rem; }
.tip-toggle:hover { text-decoration:underline; }
.steps-row { display:flex; justify-content:center; gap:2rem; margin-top:1.5rem; flex-wrap:wrap; }
.step-item { display:flex; align-items:center; gap:0.6rem; font-size:0.8rem; color:var(--soft); }
.step-num { width:28px; height:28px; border-radius:50%; background:var(--accent-light); color:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.75rem; }

/* ── HERO ── */
.hero {
  text-align:center; padding:3.5rem 2.5rem 3rem;
}
.hero-chip {
  display:inline-flex; align-items:center; gap:0.5rem;
  font-size:0.7rem; font-weight:600; letter-spacing:0.08em; text-transform:uppercase;
  color:var(--accent); border:1px solid var(--border); border-radius:999px;
  padding:0.35rem 1rem; margin-bottom:1.8rem;
  background:var(--accent-light);
}
.hero h1 {
  font-size:clamp(2.2rem,5vw,3.5rem); font-weight:800; letter-spacing:-0.03em; line-height:1.25;
  margin-bottom:1rem; animation:fadeUp 0.6s ease 0.1s both;
}
.hero h1 .grad { color:var(--accent); }
.hero p { font-size:1.05rem; color:var(--soft); max-width:520px; margin:0 auto; line-height:1.7; animation:fadeUp 0.6s ease 0.2s both; }
@keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

/* ── MAIN GRID ── */
.main-grid {
  display:grid; grid-template-columns:300px 1fr;
  gap:2rem; padding-bottom:5rem; align-items:start;
}

/* ── PANEL ── */
.panel {
  background:var(--bg-alt); border:1px solid var(--border); border-radius:16px;
  overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.04);
}
.panel-head {
  padding:1.25rem 1.6rem; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
}
.panel-head.panel-head-centered {
  justify-content:center; gap:2rem; flex-wrap:wrap;
}
.panel-head.panel-head-centered .panel-title { margin:0; }
.panel-head.panel-head-centered .mode-btn,
.panel-head.panel-head-centered .btn { min-width:90px; justify-content:center; }
.panel-title { font-size:0.75rem; font-weight:600; color:var(--soft); }
.panel-body { padding:1.75rem; }

/* ── SIDEBAR ── */
.sidebar { display:flex; flex-direction:column; gap:1.25rem; position:sticky; top:5.5rem; }

/* Template categories */
.template-search {
  width:100%; background:var(--s2); border:1px solid var(--border); border-radius:14px;
  padding:0.85rem 1.15rem; color:var(--text); font-family:var(--ui); font-size:0.9rem;
  outline:none; transition:border-color 0.2s;
}
.template-search:focus { border-color:var(--accent); }
.template-search::placeholder { color:var(--muted); }

.cat-tabs { display:flex; gap:0.4rem; flex-wrap:wrap; margin-bottom:1rem; }
.cat-tab {
  font-size:0.7rem; font-weight:600; letter-spacing:0.05em; text-transform:uppercase;
  padding:0.4rem 0.85rem; border-radius:999px; cursor:pointer;
  border:1px solid var(--border); background:transparent; color:var(--muted);
  transition:all 0.15s;
}
.cat-tab.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.cat-tab:hover:not(.active) { border-color:var(--border2); color:var(--text); }

.template-list { display:flex; flex-direction:column; gap:0.6rem; max-height:300px; overflow-y:auto; }
.template-list::-webkit-scrollbar { width:4px; }
.template-list::-webkit-scrollbar-thumb { background:var(--s3); border-radius:4px; }

.tpl-card {
  padding:1rem 1.1rem; border-radius:12px; cursor:pointer;
  border:1px solid var(--border); background:var(--s2);
  transition:all 0.15s;
}
.tpl-card:hover { border-color:var(--accent); background:var(--accent-light); }
.tpl-card.active { border-color:var(--accent); background:var(--accent-light); }
.tpl-name { font-size:0.8rem; font-weight:600; margin-bottom:0.2rem; }
.tpl-desc { font-size:0.68rem; color:var(--muted); line-height:1.5; }
.tpl-tag {
  display:inline-block; font-size:0.58rem; font-weight:700; letter-spacing:0.06em; text-transform:uppercase;
  padding:0.12rem 0.4rem; border-radius:4px; margin-top:0.4rem;
}

/* Tips */
.tip-card {
  background:var(--s2); border:1px solid var(--border); border-radius:14px; padding:1.25rem;
}
.tip-title { font-size:0.7rem; font-weight:700; color:var(--accent); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:0.6rem; }
.tip-item { font-size:0.82rem; color:var(--soft); line-height:1.7; padding-left:1rem; border-left:3px solid var(--accent); margin-bottom:0.6rem; opacity:0.9; }
.tip-item strong { color:var(--text); }

/* ── BUILDER ── */
.builder { display:flex; flex-direction:column; gap:1.25rem; }

/* Quick start templates */
.quick-start { display:flex; flex-wrap:wrap; gap:0.75rem; margin-bottom:1.75rem; }
.quick-tpl {
  font-size:0.85rem; padding:0.6rem 1.2rem; border-radius:999px;
  border:1px solid var(--border); background:var(--bg-alt); color:var(--soft);
  cursor:pointer; transition:all 0.15s;
}
.quick-tpl:hover { border-color:var(--accent); color:var(--accent); background:var(--accent-light); }

/* Core fields - simplified */
.core-fields { display:flex; flex-direction:column; gap:1.5rem; }
.core-fields .field input, .core-fields .field textarea { font-size:1rem; padding:1.15rem 1.5rem; border-radius:14px; line-height:1.55; }
.core-fields .field label { font-size:0.75rem; font-weight:600; color:var(--text); }
.core-fields .field label .lbadge { font-size:0.6rem; }

/* Fields */
.field-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
.field { display:flex; flex-direction:column; gap:0.5rem; }
.field.full { grid-column:1/-1; }
.field label {
  font-size:0.7rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:var(--soft);
  display:flex; align-items:center; gap:0.4rem;
}
.field label .lbadge {
  font-size:0.55rem; padding:0.1rem 0.4rem; border-radius:4px;
  background:var(--accent-light); color:var(--accent); border:1px solid var(--border);
}
.field label .lbadge.req { background:#fef2f2; color:var(--danger); border-color:#fecaca; }

textarea, input[type="text"], select {
  width:100%; background:var(--s2); border:1px solid var(--border); border-radius:14px;
  padding:1rem 1.35rem; color:var(--text); font-family:var(--ui); font-size:0.92rem;
  outline:none; transition:border-color 0.2s, box-shadow 0.2s; resize:vertical; line-height:1.5;
}
textarea:focus, input[type="text"]:focus, select:focus {
  border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,0.15);
}
textarea::placeholder, input::placeholder { color:var(--muted); }
select option { background:var(--s2); }

/* Chips toggle group */
.chips { display:flex; flex-wrap:wrap; gap:0.6rem; }
.chip {
  font-size:0.82rem; font-weight:500; padding:0.55rem 1.1rem; border-radius:14px;
  border:1px solid var(--border); background:var(--s2); color:var(--soft); cursor:pointer;
  transition:all 0.15s;
}
.chip.active { background:var(--accent-light); border-color:var(--accent); color:var(--accent); }
.chip:hover:not(.active) { border-color:var(--border2); color:var(--text); }

/* Slider */
.slider-row { display:flex; align-items:center; gap:0.8rem; }
input[type="range"] {
  flex:1; height:3px; background:var(--s3); border-radius:2px;
  outline:none; cursor:pointer; accent-color:var(--accent);
}
.slider-val {
  font-family:var(--mono); font-size:0.78rem; color:var(--accent);
  background:var(--accent-light); padding:0.35rem 0.65rem; border-radius:10px; min-width:2.5rem; text-align:center;
}

/* ── OUTPUT PANEL ── */
.output-area {
  background:var(--s2); border:1px solid var(--border); border-radius:14px;
  min-height:160px; padding:1.25rem 1.5rem; font-family:var(--mono); font-size:0.85rem; line-height:1.85;
  color:var(--text); position:relative; transition:border-color 0.3s;
  white-space:pre-wrap; word-break:break-word;
}
.output-area.streaming { border-color:var(--accent); }
.output-placeholder { color:var(--muted); font-style:italic; font-family:var(--ui); }
.cursor { display:inline-block; width:2px; height:1em; background:var(--accent); animation:blink 0.8s step-end infinite; vertical-align:text-bottom; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

.output-actions {
  display:flex; gap:0.6rem; margin-top:1rem; flex-wrap:wrap; align-items:center; justify-content:space-between;
}

/* ── SCORE BAR ── */
/* Score dans la sidebar : 2x2 pour éviter le chevauchement */
.sidebar .score-grid {
  grid-template-columns:repeat(2,1fr);
  gap:1.25rem;
  margin-bottom:1.5rem;
  padding:0.75rem 0;
}
.sidebar .score-ring {
  width:52px;
  height:52px;
}
.sidebar .score-ring svg {
  width:52px;
  height:52px;
  transform:rotate(-90deg);
  display:block;
}
.sidebar .score-item { gap:0.6rem; }
.sidebar .score-num { font-size:0.9rem; }
.sidebar .score-label { font-size:0.68rem; min-height:auto; }
.sidebar .score-bars-section { margin-top:1.25rem; padding-top:1rem; }
.sidebar .score-bar-label { font-size:0.7rem; }

.score-grid {
  display:grid; grid-template-columns:repeat(4,1fr); gap:1.5rem;
  margin-bottom:1.5rem; padding:0.75rem 0;
}
.score-item {
  text-align:center; min-width:0;
  display:flex; flex-direction:column; align-items:center; gap:0.85rem;
}
.score-ring {
  width:64px; height:64px; flex-shrink:0;
  position:relative; margin:0;
}
.score-ring svg { transform:rotate(-90deg); display:block; }
.ring-bg { fill:none; stroke:var(--s3); stroke-width:5; }
.ring-fg { fill:none; stroke-width:5; stroke-linecap:round; transition:stroke-dasharray 0.6s ease, stroke 0.3s; }
.score-num {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-size:1rem; font-weight:700; font-family:var(--mono); color:inherit;
}
.score-label {
  font-size:0.72rem; font-weight:600; color:var(--muted);
  letter-spacing:0.05em; text-transform:uppercase;
  line-height:1.35; min-height:1.6em;
}

.score-bars-section { margin-top:1.5rem; padding-top:1.25rem; border-top:1px solid var(--border); }
.score-bar-label { font-size:0.78rem; color:var(--soft); margin-bottom:0.5rem; display:flex; justify-content:space-between; }
.score-bar-track { height:6px; background:var(--s3); border-radius:3px; overflow:hidden; margin-bottom:1rem; }
.score-bar-fill { height:100%; border-radius:2px; transition:width 0.5s ease; }

/* ── FEEDBACK ── */
.feedback-list { display:flex; flex-direction:column; gap:0.75rem; margin-top:1rem; }
.fb-item {
  display:flex; gap:0.75rem; align-items:start;
  padding:0.85rem 1rem; border-radius:12px; font-size:0.84rem; line-height:1.6;
}
.fb-ok   { background:#ecfdf5; border:1px solid #a7f3d0; color:var(--success); }
.fb-warn { background:#fffbeb; border:1px solid #fde68a; color:var(--warn); }
.fb-bad  { background:#fef2f2; border:1px solid #fecaca; color:var(--danger); }
.fb-icon { flex-shrink:0; font-size:0.9rem; }

/* ── BUTTONS ── */
.btn {
  font-family:var(--ui); font-size:0.92rem; font-weight:600;
  padding:0.8rem 1.6rem; border-radius:999px; cursor:pointer;
  border:none; transition:all 0.2s; display:inline-flex; align-items:center; gap:0.5rem;
}
.btn-primary {
  background:var(--accent); color:#fff;
}
.btn-primary:hover { background:var(--accent-hover); }
.btn-primary:active { transform:translateY(0); }
.btn-primary:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

.btn-ghost {
  background:var(--s2); border:1px solid var(--border); color:var(--soft);
}
.btn-ghost:hover { border-color:var(--border2); color:var(--text); }

.btn-green { background:var(--success); color:#fff; }
.btn-green:hover { filter:brightness(1.05); }

.btn-sm { font-size:0.82rem; padding:0.6rem 1.2rem; border-radius:999px; }

/* ── IMPROVED PROMPT ── */
.improved-box {
  background:var(--accent-light); border:1px solid var(--border); border-radius:18px; padding:1.75rem;
  position:relative; overflow:hidden;
}
.improved-box::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:var(--accent);
}
.improved-label {
  font-size:0.65rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase;
  color:var(--accent); margin-bottom:0.8rem; display:flex; align-items:center; gap:0.4rem;
}
.improved-text {
  font-family:var(--mono); font-size:0.85rem; line-height:1.85; color:var(--text);
  white-space:pre-wrap; word-break:break-word;
}

/* ── TABS ── */
.tabs { display:flex; gap:0.2rem; border-bottom:1px solid var(--border); margin-bottom:1rem; }
.tab {
  font-size:0.72rem; font-weight:600; padding:0.65rem 1rem; cursor:pointer;
  border:none; background:transparent; color:var(--muted);
  border-bottom:2px solid transparent; margin-bottom:-1px; transition:all 0.15s;
}
.tab.active { color:var(--text); border-bottom-color:var(--accent); }
.tab:hover:not(.active) { color:var(--soft); }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* Spinner */
.spinner {
  width:16px;height:16px; border:2px solid var(--border);
  border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

/* Copy toast */
.toast {
  position:fixed; bottom:2rem; right:2rem; z-index:999;
  background:var(--bg-alt); border:1px solid var(--border); border-radius:14px;
  padding:0.8rem 1.2rem; font-size:0.8rem; font-weight:600; color:var(--accent);
  display:flex; align-items:center; gap:0.5rem;
  transform:translateY(20px); opacity:0; transition:all 0.3s;
  pointer-events:none;
}
.toast.show { transform:translateY(0); opacity:1; }

/* ── HISTORY ── */
.history-list { display:flex; flex-direction:column; gap:0.5rem; max-height:300px; overflow-y:auto; }
.hist-item {
  background:var(--s2); border:1px solid var(--border); border-radius:12px;
  padding:0.9rem 1.1rem; cursor:pointer; transition:all 0.15s;
}
.hist-item:hover { border-color:var(--border2); }
.hist-item-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem; }
.hist-item-label { font-size:0.7rem; font-weight:600; color:var(--soft); }
.hist-item-score { font-family:var(--mono); font-size:0.68rem; color:var(--accent); }
.hist-item-preview { font-size:0.73rem; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* char counter */
.char-count { font-family:var(--mono); font-size:0.65rem; color:var(--muted); text-align:right; margin-top:0.25rem; }

/* divider */
.divider { height:1px; background:var(--border); margin:1rem 0; }

/* Builder actions - centré, espacement, boutons égaux */
.builder-actions {
  display:flex; flex-wrap:wrap; gap:1rem; align-items:center;
  justify-content:center; padding:1rem 0; margin-top:0.5rem;
}
.builder-actions .btn { min-width:160px; justify-content:center; }

/* Modal */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000; opacity:0; pointer-events:none; transition:opacity 0.2s; }
.modal-overlay.show { opacity:1; pointer-events:auto; }
.modal { background:var(--bg-alt); border-radius:18px; padding:1.75rem; max-width:420px; width:90%; box-shadow:0 20px 50px rgba(0,0,0,0.2); }
.modal h3 { font-size:1.1rem; margin-bottom:1rem; color:var(--text); }
.modal label { display:block; font-size:0.75rem; font-weight:600; color:var(--soft); margin-bottom:0.5rem; }
.modal input { width:100%; padding:0.8rem 1rem; border:1px solid var(--border); border-radius:12px; background:var(--s2); color:var(--text); font-family:var(--mono); font-size:0.85rem; margin-bottom:1rem; }
.modal input::placeholder { color:var(--muted); }
.modal-actions { display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem; }

/* Onboarding */
.onboarding-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:999; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
.onboarding-overlay.show { opacity:1; pointer-events:auto; }
.onboarding-card { background:var(--bg-alt); border-radius:18px; padding:2rem; max-width:400px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,0.15); }
.onboarding-card h3 { font-size:1.2rem; margin-bottom:0.75rem; color:var(--text); }
.onboarding-card p { font-size:0.9rem; color:var(--soft); line-height:1.6; margin-bottom:1rem; }
.onboarding-card .btn { margin-top:0.5rem; }

/* Feedback buttons */
.feedback-btns { display:flex; gap:0.5rem; margin-top:0.75rem; }
.feedback-btns button { padding:0.4rem 0.8rem; font-size:0.75rem; border-radius:8px; border:1px solid var(--border); background:var(--s2); color:var(--muted); cursor:pointer; transition:all 0.15s; }
.feedback-btns button:hover { border-color:var(--accent); color:var(--accent); }

@media(max-width:900px) {
  body { padding:1rem 1.25rem; }
  .main-grid { grid-template-columns:1fr; }
  .sidebar { position:static; }
  .score-grid { grid-template-columns:repeat(2,1fr); }
  .field-grid { grid-template-columns:1fr; }
  .api-grid { grid-template-columns:1fr; }
  header { flex-wrap:wrap; gap:1rem; }
}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:0.75rem">
  <div class="logo">
    <div class="logo-icon"><i data-lucide="zap"></i></div>
    <div>
      <div>PromptForge</div>
      <div class="header-tagline">Générateur de prompts IA performants</div>
    </div>
  </div>
  <button type="button" class="btn btn-ghost btn-sm" onclick="toggleDarkMode()" title="Mode sombre" aria-label="Basculer le mode sombre"><i data-lucide="moon" class="icon icon-sm" id="theme-icon"></i></button>
  </div>
  <nav class="header-nav">
    <button class="header-nav-btn active" data-view="builder"><i data-lucide="hammer" class="icon icon-sm"></i> Builder</button>
    <button class="header-nav-btn" data-view="apis"><i data-lucide="radio" class="icon icon-sm"></i> APIs</button>
    <div class="dropdown-nav" id="dropdown-nav">
      <button class="header-nav-btn" onclick="toggleDropdown()"><i data-lucide="book-open" class="icon icon-sm"></i> Ressources <i data-lucide="chevron-down" class="icon icon-sm"></i></button>
      <div class="dropdown-menu">
        <button data-view="glossaire" onclick="navTo('glossaire')"><i data-lucide="book" class="icon icon-sm"></i> Glossaire IA</button>
        <button data-view="bonnes-pratiques" onclick="navTo('bonnes-pratiques')"><i data-lucide="sparkles" class="icon icon-sm"></i> Bonnes pratiques</button>
        <button data-view="ressources" onclick="navTo('ressources')"><i data-lucide="link" class="icon icon-sm"></i> Liens & actualités</button>
        <button data-view="bibliotheque" onclick="navTo('bibliotheque')"><i data-lucide="save" class="icon icon-sm"></i> Bibliothèque</button>
        <button data-view="guide-builder" onclick="navTo('guide-builder')"><i data-lucide="help-circle" class="icon icon-sm"></i> Guide du builder</button>
        <button type="button" onclick="toggleDropdown();showSettingsModal()"><i data-lucide="settings" class="icon icon-sm"></i> Paramètres</button>
      </div>
    </div>
  </nav>
</header>

<div class="container">

  <!-- Vue Builder -->
  <section id="view-builder" class="view-section active">
  <section class="hero">
    <h1>Crée ton prompt en 3 champs</h1>
    <p>Rôle, objectif, tâche — puis Générer. Ou choisis un template pour démarrer.</p>
  </section>

  <div class="main-grid">

    <!-- ── SIDEBAR ── -->
    <aside class="sidebar">

      <!-- Templates -->
      <div class="panel">
        <div class="panel-head">
          <span class="panel-title"><i data-lucide="package" class="icon icon-sm"></i> Templates</span>
          <span style="font-size:0.65rem;color:var(--muted)" id="tpl-count">35 templates</span>
        </div>
        <div class="panel-body">
          <input class="template-search" type="text" placeholder="Rechercher un template…" id="tpl-search">
          <div style="margin-top:0.8rem">
            <div class="cat-tabs" id="cat-tabs">
              <button class="cat-tab active" data-cat="all">Tous</button>
              <button class="cat-tab" data-cat="code">Code</button>
              <button class="cat-tab" data-cat="content">Contenu</button>
              <button class="cat-tab" data-cat="web">Web</button>
              <button class="cat-tab" data-cat="data">Data</button>
              <button class="cat-tab" data-cat="agent">Agent</button>
            </div>
            <div class="template-list" id="tpl-list"></div>
          </div>
        </div>
      </div>

      <!-- Tips -->
      <div class="tip-card collapsible collapsed" id="tip-card">
        <div class="tip-title"><i data-lucide="lightbulb" class="icon icon-sm"></i> Conseils rapides</div>
        <div class="tip-body">
          <div class="tip-item"><strong>Rôle précis</strong> — Spécialisation + expérience</div>
          <div class="tip-item"><strong>Format</strong> — JSON, markdown, liste…</div>
          <div class="tip-item"><strong>Exemples</strong> — 1 exemple = 10x plus efficace</div>
        </div>
        <div class="tip-toggle" id="tip-toggle" onclick="toggleTips()">Voir plus de conseils</div>
      </div>

      <!-- Score panel -->
      <div class="panel" id="score-panel" style="display:none">
        <div class="panel-head"><span class="panel-title"><i data-lucide="bar-chart-2" class="icon icon-sm"></i> Score de qualité</span></div>
        <div class="panel-body">
          <div class="score-grid">
            <div class="score-item">
              <div class="score-ring">
                <svg viewBox="0 0 56 56" width="64" height="64">
                  <circle class="ring-bg" cx="28" cy="28" r="24"/>
                  <circle class="ring-fg" id="ring-global" cx="28" cy="28" r="24" stroke="var(--accent)" stroke-dasharray="0 150.8"/>
                </svg>
                <div class="score-num" id="num-global" style="color:var(--accent)">0</div>
              </div>
              <div class="score-label">Global</div>
            </div>
            <div class="score-item">
              <div class="score-ring">
                <svg viewBox="0 0 56 56" width="64" height="64">
                  <circle class="ring-bg" cx="28" cy="28" r="24"/>
                  <circle class="ring-fg" id="ring-clarity" cx="28" cy="28" r="24" stroke="#60a5fa" stroke-dasharray="0 150.8"/>
                </svg>
                <div class="score-num" id="num-clarity" style="color:#60a5fa">0</div>
              </div>
              <div class="score-label">Clarté</div>
            </div>
            <div class="score-item">
              <div class="score-ring">
                <svg viewBox="0 0 56 56" width="64" height="64">
                  <circle class="ring-bg" cx="28" cy="28" r="24"/>
                  <circle class="ring-fg" id="ring-structure" cx="28" cy="28" r="24" stroke="#a78bfa" stroke-dasharray="0 150.8"/>
                </svg>
                <div class="score-num" id="num-structure" style="color:#a78bfa">0</div>
              </div>
              <div class="score-label">Structure</div>
            </div>
            <div class="score-item">
              <div class="score-ring">
                <svg viewBox="0 0 56 56" width="64" height="64">
                  <circle class="ring-bg" cx="28" cy="28" r="24"/>
                  <circle class="ring-fg" id="ring-specificity" cx="28" cy="28" r="24" stroke="var(--accent2)" stroke-dasharray="0 150.8"/>
                </svg>
                <div class="score-num" id="num-specificity" style="color:var(--accent2)">0</div>
              </div>
              <div class="score-label">Précision</div>
            </div>
          </div>

          <div id="score-bars" class="score-bars-section">
            <div class="score-bar-label"><span>Complétude des champs</span><span id="bar-fields-val">0%</span></div>
            <div class="score-bar-track"><div class="score-bar-fill" id="bar-fields" style="width:0%;background:var(--accent)"></div></div>

            <div class="score-bar-label"><span>Richesse du contexte</span><span id="bar-context-val">0%</span></div>
            <div class="score-bar-track"><div class="score-bar-fill" id="bar-context" style="width:0%;background:#60a5fa"></div></div>

            <div class="score-bar-label"><span>Techniques avancées</span><span id="bar-tech-val">0%</span></div>
            <div class="score-bar-track"><div class="score-bar-fill" id="bar-tech" style="width:0%;background:#a78bfa"></div></div>
          </div>

          <div class="feedback-list" id="feedback-list" style="margin-top:1rem"></div>
        </div>
      </div>

      <!-- History -->
      <div class="panel">
        <div class="panel-head">
          <span class="panel-title"><i data-lucide="clock" class="icon icon-sm"></i> Historique</span>
          <button class="btn btn-ghost btn-sm" onclick="clearHistory()">Effacer</button>
        </div>
        <div class="panel-body">
          <div class="history-list" id="hist-list">
            <div style="font-size:0.75rem;color:var(--muted);text-align:center;padding:1rem">Aucun prompt généré</div>
          </div>
        </div>
      </div>

    </aside>

    <!-- ── MAIN ── -->
    <div class="builder">

      <!-- Builder form -->
      <div class="panel">
        <div class="panel-head panel-head-centered">
          <span class="panel-title">Nouveau prompt</span>
          <div style="display:flex;gap:0.75rem;align-items:center">
            <div class="mode-toggle">
              <button class="mode-btn active" id="mode-simple" onclick="setMode('simple')">Simple</button>
              <button class="mode-btn" id="mode-complet" onclick="setMode('complet')">Complet</button>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="resetForm()">↺ Reset</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="quick-start">
            <span style="font-size:0.75rem;color:var(--muted);align-self:center;margin-right:0.5rem">Démarrer avec :</span>
            <button type="button" class="quick-tpl" onclick="loadTemplate(1)">Code Review</button>
            <button type="button" class="quick-tpl" onclick="loadTemplate(2)">SEO</button>
            <button type="button" class="quick-tpl" onclick="loadTemplate(13)">Landing page</button>
            <button type="button" class="quick-tpl" onclick="loadTemplate(6)">Résumé exécutif</button>
          </div>

          <div class="core-fields">
            <div class="field">
              <label title="Qui est l'assistant IA : expertise, niveau, spécialités"><i data-lucide="user" class="icon icon-sm"></i> Rôle</label>
              <input type="text" id="f-role" placeholder="Ex: Expert cybersécurité avec 15 ans d'expérience" oninput="liveScore()">
            </div>

            <div class="field">
              <label title="Ce que tu veux obtenir en une phrase"><i data-lucide="target" class="icon icon-sm"></i> Objectif</label>
              <input type="text" id="f-goal" placeholder="Ex: Auditer ce code Python et trouver les vulnérabilités" oninput="liveScore()">
            </div>

            <div class="field">
              <label title="Instructions détaillées : comment procéder, étapes, format attendu"><i data-lucide="list-checks" class="icon icon-sm"></i> Tâche</label>
              <textarea id="f-task" rows="4" placeholder="Ex: Analyse le code ligne par ligne. Pour chaque problème : niveau (CRITIQUE/MAJEUR/MINEUR), explication et correction." oninput="liveScore()"></textarea>
              <div class="char-count" id="cc-task">0 / 1000</div>
            </div>
          </div>

            <div class="advanced-toggle" data-block="block-options" onclick="toggleBlock('block-options')"><span class="arrow">▶</span> Plus d'options (contexte, format, ton…)</div>

            <div class="advanced-block collapsed" id="block-options" style="grid-column:1/-1">
            <div class="field-grid">
            <div class="field full">
              <label title="Infos utiles : stack technique, contraintes, audience"><i data-lucide="file-text" class="icon icon-sm"></i> Contexte</label>
              <textarea id="f-context" rows="2" placeholder="Ex: L'app gère des données bancaires, FastAPI, prod" oninput="liveScore()"></textarea>
              <div class="char-count" id="cc-context">0 / 500</div>
            </div>
            <div class="field">
              <label title="Type de réponse : JSON, markdown, liste, tableau…"><i data-lucide="layout" class="icon icon-sm"></i> Format de sortie</label>
              <select id="f-format" onchange="liveScore()">
                <option value="">-- Choisir --</option>
                <option value="markdown structuré avec titres et bullet points">Markdown structuré</option>
                <option value="JSON strict avec les clés définies">JSON</option>
                <option value="liste numérotée">Liste numérotée</option>
                <option value="tableau comparatif">Tableau</option>
                <option value="code commenté">Code commenté</option>
                <option value="rapport exécutif synthétique">Rapport exécutif</option>
                <option value="réponse courte en 3 lignes max">Ultra-court (3 lignes)</option>
                <option value="texte structuré avec examples concrets">Texte + Exemples</option>
              </select>
            </div>

            <div class="field">
              <label><i data-lucide="globe" class="icon icon-sm"></i> Langue de sortie</label>
              <select id="f-lang" onchange="liveScore()">
                <option value="">Même que l'input</option>
                <option value="fr">Français</option>
                <option value="en">English</option>
                <option value="es">Español</option>
                <option value="de">Deutsch</option>
              </select>
            </div>
            <div class="field">
              <label><i data-lucide="type" class="icon icon-sm"></i> Ton / Style</label>
              <select id="f-tone" onchange="liveScore()">
                <option value="">-- Choisir --</option>
                <option value="expert et technique, sans vulgarisation">Expert technique</option>
                <option value="pédagogique et clair, accessible à un débutant">Pédagogique</option>
                <option value="direct et concis, sans fioritures">Direct & concis</option>
                <option value="créatif et engageant">Créatif</option>
                <option value="formel et professionnel">Formel</option>
                <option value="conversationnel et amical">Conversationnel</option>
              </select>
            </div>

            <div class="field full">
              <label title="1 exemple input→output = 10x plus efficace pour calibrer le format"><i data-lucide="copy" class="icon icon-sm"></i> Exemple(s) souhaité(s) <span class="lbadge">+Score</span></label>
              <textarea id="f-example" rows="2" placeholder="Ex: Input: def login(user, pwd): ... → Output: [CRITIQUE] Injection SQL ligne 2..." oninput="liveScore()"></textarea>
            </div>

            <div class="field full">
              <label><i data-lucide="ban" class="icon icon-sm"></i> Contraintes / Ce qu'il ne faut pas faire</label>
              <textarea id="f-constraints" rows="2" placeholder="Ex: Pas de jargon, max 200 mots..." oninput="liveScore()"></textarea>
            </div>
            </div></div>

            <div class="advanced-toggle" data-block="block-expert" onclick="toggleBlock('block-expert')"><span class="arrow">▶</span> Mode expert</div>

            <div class="advanced-block collapsed" id="block-expert" style="grid-column:1/-1">
            <div class="field-grid">
            <div class="field full">
              <label title="Format: nom: valeur | autre: val — utilise {{nom}} dans le prompt"><i data-lucide="variable" class="icon icon-sm"></i> Variables dynamiques</label>
              <input type="text" id="f-vars" placeholder="sujet: landing page | ton: professionnel | client: startup B2B" oninput="liveScore()">
              <div class="var-hint">Format : <code>nom: valeur</code> séparés par <code>|</code>. Utilise <code>{{nom}}</code> dans le prompt.</div>
            </div>

            <div class="field full">
              <label><i data-lucide="cpu" class="icon icon-sm"></i> Techniques</label>
              <div class="chips" id="tech-chips">
                <div class="chip" data-chip="Chain of Thought" data-val="Pense étape par étape avant de répondre." onclick="toggleChip(this)"><i data-lucide="link" class="icon icon-sm"></i> Chain of Thought</div>
                <div class="chip" data-chip="Hypothèses" data-val="Avant de répondre, liste les hypothèses que tu poses." onclick="toggleChip(this)"><i data-lucide="brain" class="icon icon-sm"></i> Hypothèses</div>
                <div class="chip" data-chip="Confiance" data-val="Si tu n'es pas sûr, indique-le explicitement avec un niveau de confiance." onclick="toggleChip(this)"><i data-lucide="target" class="icon icon-sm"></i> Confiance</div>
                <div class="chip" data-chip="TL;DR first" data-val="Commence par un bref résumé, puis développe." onclick="toggleChip(this)"><i data-lucide="file-text" class="icon icon-sm"></i> TL;DR first</div>
                <div class="chip" data-chip="3 variantes" data-val="Donne 3 variantes avec des approches différentes." onclick="toggleChip(this)"><i data-lucide="git-branch" class="icon icon-sm"></i> 3 variantes</div>
                <div class="chip" data-chip="Auto-critique" data-val="Critique ta propre réponse et améliore-la." onclick="toggleChip(this)"><i data-lucide="refresh-cw" class="icon icon-sm"></i> Auto-critique</div>
                <div class="chip" data-chip="Analogies" data-val="Utilise des analogies pour chaque concept complexe." onclick="toggleChip(this)"><i data-lucide="lightbulb" class="icon icon-sm"></i> Analogies</div>
                <div class="chip" data-chip="XML output" data-val="Réponds en XML structuré." onclick="toggleChip(this)"><i data-lucide="code" class="icon icon-sm"></i> XML output</div>
              </div>
            </div>

            <div class="field full" style="margin-top:0.5rem">
              <label><i data-lucide="code" class="icon icon-sm"></i> Snippets web</label>
              <div class="chips" id="snippet-chips">
                <span class="snippet-chip" data-snippet="Structure la page en sections sémantiques (header, hero, features, cta, footer)." onclick="insertSnippet(this)">Sections HTML5</span>
                <span class="snippet-chip" data-snippet="Utilise Tailwind CSS pour le style. Classes utilitaires uniquement." onclick="insertSnippet(this)">Tailwind CSS</span>
                <span class="snippet-chip" data-snippet="Génère un composant React avec TypeScript et hooks." onclick="insertSnippet(this)">Composant React</span>
                <span class="snippet-chip" data-snippet="Design responsive mobile-first." onclick="insertSnippet(this)">Mobile-first</span>
                <span class="snippet-chip" data-snippet="Ajoute des micro-interactions et transitions CSS." onclick="insertSnippet(this)">Micro-interactions</span>
                <span class="snippet-chip" data-snippet="Structure avec user stories : En tant que [persona], je veux [action] afin de [bénéfice]." onclick="insertSnippet(this)">User stories</span>
              </div>
            </div>

            <div class="field full">
              <label><i data-lucide="move-horizontal" class="icon icon-sm"></i> Longueur</label>
              <div class="slider-row">
                <input type="range" id="f-length" min="1" max="5" value="3" oninput="updateLength(this)">
                <span class="slider-val" id="length-label">Moyenne</span>
              </div>
            </div>
            </div></div>

          </div>

          <div class="divider" style="margin:1.75rem 0"></div>

          <div class="builder-actions">
            <button class="btn btn-primary" id="gen-btn" onclick="generatePrompt()">
              <span id="gen-icon"><i data-lucide="zap"></i></span> <span id="gen-text">Générer le prompt</span>
            </button>
            <button class="btn btn-ghost" onclick="showPreview()" type="button"><i data-lucide="eye" class="icon icon-sm"></i> Prévisualiser</button>
            <button class="btn btn-ghost" onclick="showImportPromptModal()" type="button"><i data-lucide="clipboard-paste" class="icon icon-sm"></i> Coller un prompt</button>
            <button class="btn btn-ghost" onclick="fillExample()" type="button">Exemple rapide</button>
            <button class="btn btn-ghost" onclick="analyzeOnly()"><i data-lucide="search" class="icon icon-sm"></i> Analyser</button>
            <button class="btn btn-ghost" onclick="saveToLibrary()" title="Sauvegarder"><i data-lucide="save" class="icon icon-sm"></i></button>
            <span style="font-size:0.72rem;color:var(--muted);width:100%;text-align:center;display:block;margin-top:0.5rem" id="live-score-badge"></span>
          </div>
        </div>
      </div>

      <!-- Output tabs -->
      <div class="panel" id="output-panel" style="display:none">
        <div class="panel-head"><span class="panel-title"><i data-lucide="sparkles" class="icon icon-sm"></i> Résultats</span></div>
        <div class="panel-body">
          <div class="tabs">
            <button class="tab active" data-tab="out-prompt">Prompt généré</button>
            <button class="tab" data-tab="out-improved">Version améliorée</button>
            <button class="tab" data-tab="out-analysis">Analyse IA</button>
            <button class="tab" data-tab="out-ab">A/B Comparaison</button>
          </div>

          <div id="out-prompt" class="tab-panel active">
            <div class="output-area" id="prompt-output"><span class="output-placeholder">Le prompt apparaîtra ici…</span></div>
            <div class="output-actions">
              <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                <button class="btn btn-ghost btn-sm" onclick="copyOutput('prompt-output')"><i data-lucide="copy" class="icon icon-sm"></i> Copier</button>
                <button class="btn btn-ghost btn-sm" onclick="downloadPromptTxt()"><i data-lucide="file-down" class="icon icon-sm"></i> Télécharger .txt</button>
                <button class="btn btn-ghost btn-sm" onclick="sharePromptLink()"><i data-lucide="share-2" class="icon icon-sm"></i> Partager</button>
                <button class="btn btn-ghost btn-sm" onclick="showPreview()"><i data-lucide="eye" class="icon icon-sm"></i> Prévisualiser</button>
                <button class="btn btn-ghost btn-sm" onclick="improvePrompt()"><i data-lucide="sparkles" class="icon icon-sm"></i> Améliorer avec l'IA</button>
              </div>
              <span style="font-size:0.68rem;color:var(--muted)" id="prompt-char-count"></span>
            </div>
            <div class="feedback-btns" id="feedback-btns" style="display:none">
              <span style="font-size:0.72rem;color:var(--muted);margin-right:0.25rem">Ce prompt t'a aidé ?</span>
              <button onclick="sendFeedback(1)" type="button"><i data-lucide="thumbs-up" style="width:12px;height:12px"></i> Oui</button>
              <button onclick="sendFeedback(-1)" type="button"><i data-lucide="thumbs-down" style="width:12px;height:12px"></i> Non</button>
            </div>
          </div>

          <div id="out-improved" class="tab-panel">
            <div class="improved-box">
              <div class="improved-label"><i data-lucide="zap" class="icon icon-sm"></i> Version optimisée par l'IA</div>
              <div class="improved-text" id="improved-output">Clique sur "Améliorer avec l'IA" pour générer une version optimisée…</div>
            </div>
            <div class="output-actions">
              <button class="btn btn-green btn-sm" onclick="copyOutput('improved-output')"><i data-lucide="copy" class="icon icon-sm"></i> Copier la version améliorée</button>
            </div>
          </div>

          <div id="out-analysis" class="tab-panel">
            <div class="output-area" id="analysis-output" style="min-height:200px"><span class="output-placeholder">L'analyse apparaîtra ici…</span></div>
          </div>
          <div id="out-ab" class="tab-panel">
            <div class="comparison-grid">
              <div class="comparison-box"><div class="comparison-label">Variante A (actuelle)</div><div id="ab-a" style="font-size:0.78rem;white-space:pre-wrap;word-break:break-word;color:var(--soft)">—</div></div>
              <div class="comparison-box"><div class="comparison-label">Variante B</div><div id="ab-b" style="font-size:0.78rem;white-space:pre-wrap;word-break:break-word;color:var(--soft)">—</div></div>
            </div>
            <div style="margin-top:0.8rem"><button class="btn btn-ghost btn-sm" onclick="generateVariantB()"><i data-lucide="refresh-cw" class="icon icon-sm"></i> Générer variante B</button></div>
          </div>
        </div>
      </div>

    </div><!-- /builder -->
  </div><!-- /main-grid -->
  </section><!-- /view-builder -->

  <!-- Vue APIs IA -->
  <section id="view-apis" class="view-section api-page">
    <h2 class="section-title">APIs IA — Trouve celle qu'il te faut</h2>
    <div class="api-recommender">
      <h3><i data-lucide="message-circle" class="icon icon-sm"></i> Décris ce que tu veux faire</h3>
      <p>Ex : "Je veux coder un chatbot pas cher" — "Analyser des documents longs" — "Faire du contenu SEO"</p>
      <div class="api-recommender-row">
        <input type="text" class="api-recommender-input" id="api-need-input" placeholder="Je veux..." onkeydown="if(event.key==='Enter')recommendApi()">
        <button class="btn btn-primary" onclick="recommendApi()">Me conseiller</button>
      </div>
      <div class="recommended-result" id="recommended-result" style="display:none">
        <div class="rec-title">APIs recommandées pour toi</div>
        <div class="recommended-cards" id="recommended-cards"></div>
      </div>
    </div>
    <p class="section-desc" style="margin-top:0">Comparatif complet — prix par million de tokens (input / output).</p>
    <div class="api-grid" id="api-grid"></div>
  </section>

  <!-- Vue Guide du builder -->
  <section id="view-guide-builder" class="view-section content-page">
    <h2><i data-lucide="help-circle" class="icon icon-sm"></i> Guide du générateur de prompts</h2>
    <p>Voici l'explication de chaque élément du formulaire et comment l'utiliser pour créer des prompts efficaces.</p>
    <div id="guide-builder-content" class="bonnes-pratiques-encadre"></div>
  </section>

  <!-- Vue Glossaire -->
  <section id="view-glossaire" class="view-section content-page">
    <h2><i data-lucide="book" class="icon icon-sm"></i> Glossaire IA</h2>
    <p>Définitions essentielles pour comprendre l'univers des LLM et du prompt engineering.</p>
    <input type="text" class="lib-search" id="gloss-search" placeholder="Rechercher un terme…" oninput="filterGlossary()">
    <div class="glossary-grid" id="glossary-grid"></div>
  </section>

  <!-- Vue Bonnes pratiques -->
  <section id="view-bonnes-pratiques" class="view-section content-page">
    <h2><i data-lucide="sparkles" class="icon icon-sm"></i> Bonnes pratiques du prompt engineering</h2>
    <p>Conseils détaillés avec exemples concrets pour maximiser l'efficacité de tes prompts.</p>
    <button class="btn btn-primary btn-sm" onclick="downloadCheatSheet();showToast('Cheat sheet téléchargé')" style="margin-bottom:1rem"><i data-lucide="file-down" class="icon icon-sm"></i> Télécharger le Cheat Sheet</button>
    <div id="bonnes-pratiques-content" class="bonnes-pratiques-encadre"></div>
  </section>

  <!-- Vue Ressources -->
  <section id="view-ressources" class="view-section content-page">
    <h2><i data-lucide="link" class="icon icon-sm"></i> Ressources & actualités IA</h2>
    <p>Liens utiles pour rester informé et approfondir tes connaissances.</p>
    <div id="ressources-content"></div>
  </section>

  <!-- Vue Bibliothèque -->
  <section id="view-bibliotheque" class="view-section content-page">
    <h2><i data-lucide="save" class="icon icon-sm"></i> Bibliothèque de prompts</h2>
    <p>Gère tes prompts sauvegardés, favoris, importe et exporte.</p>
    <div class="lib-actions">
      <button class="btn btn-primary btn-sm" onclick="exportLibrary()"><i data-lucide="upload" class="icon icon-sm"></i> Exporter JSON</button>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('import-input').click()"><i data-lucide="download" class="icon icon-sm"></i> Importer</button>
      <input type="file" id="import-input" accept=".json" style="display:none" onchange="importLibrary(event)">
    </div>
    <input type="text" class="lib-search" id="lib-search" placeholder="Rechercher dans la bibliothèque…" oninput="filterLibrary()">
    <div id="lib-list"></div>
  </section>
</div>

<!-- Toast -->
<div class="toast" id="toast">Copié dans le presse-papier</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)hideSettingsModal()">
  <div class="modal">
    <h3><i data-lucide="settings" class="icon icon-sm"></i> Paramètres</h3>
    <label>Clé API Anthropic (pour Analyse, Amélioration, Variante A/B)</label>
    <input type="password" id="api-key-input" placeholder="sk-ant-...">
    <p style="font-size:0.72rem;color:var(--muted);margin-bottom:1rem">Stockée localement. Non envoyée ailleurs.</p>
    <div class="modal-actions">
      <button class="btn btn-ghost btn-sm" onclick="hideSettingsModal()">Annuler</button>
      <button class="btn btn-primary btn-sm" onclick="saveApiKey();hideSettingsModal();showToast('Clé enregistrée')">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Import prompt Modal -->
<div class="modal-overlay" id="import-prompt-modal" onclick="if(event.target===this)hideImportPromptModal()">
  <div class="modal" style="max-width:560px">
    <h3><i data-lucide="clipboard-paste" class="icon icon-sm"></i> Coller un prompt</h3>
    <p style="font-size:0.85rem;color:var(--soft);margin-bottom:1rem">Colle un prompt existant pour l'afficher, l'analyser ou l'améliorer avec l'IA.</p>
    <textarea id="import-prompt-textarea" rows="10" placeholder="Colle ton prompt ici..." style="width:100%;padding:1rem;border-radius:12px;border:1px solid var(--border);background:var(--s2);color:var(--text);font-family:var(--mono);font-size:0.85rem;resize:vertical;margin-bottom:1rem"></textarea>
    <div class="modal-actions">
      <button class="btn btn-ghost btn-sm" onclick="hideImportPromptModal()">Annuler</button>
      <button class="btn btn-primary btn-sm" onclick="confirmImportPrompt()"><i data-lucide="check" class="icon icon-sm"></i> Importer</button>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal-overlay" id="preview-modal" onclick="if(event.target===this)hidePreview()">
  <div class="modal" style="max-width:600px;max-height:80vh;overflow:auto">
    <h3><i data-lucide="eye" class="icon icon-sm"></i> Prévisualisation du prompt</h3>
    <pre id="preview-content" style="background:var(--s2);padding:1rem;border-radius:12px;font-size:0.85rem;line-height:1.6;white-space:pre-wrap;word-break:break-word;color:var(--text);max-height:400px;overflow:auto"></pre>
    <div class="modal-actions">
      <button class="btn btn-ghost btn-sm" onclick="hidePreview()">Fermer</button>
    </div>
  </div>
</div>

<!-- Onboarding -->
<div class="onboarding-overlay" id="onboarding-overlay">
  <div class="onboarding-card">
    <h3>Bienvenue sur PromptForge</h3>
    <p>Crée ton prompt en 3 étapes : <strong>Rôle</strong> (qui es-tu), <strong>Objectif</strong> (ce que tu veux), <strong>Tâche</strong> (comment). Puis clique sur Générer.</p>
    <p>Ou choisis un template pour démarrer plus vite.</p>
    <button class="btn btn-primary" onclick="dismissOnboarding()">C'est parti !</button>
  </div>
</div>

<script>
// ── DATA ──
const TEMPLATES = [
  { id:1, name:"Code Review expert", cat:"code", color:"#60a5fa", tag:"Code", desc:"Audit de code avec suggestions précises", role:"Senior software engineer avec 15 ans d'expérience en revue de code", goal:"Faire une code review approfondie du code fourni", context:"Focus sur : bugs potentiels, sécurité, performance, maintenabilité, bonnes pratiques", task:"Analyse le code suivant ligne par ligne. Identifie chaque problème avec : [NIVEAU] (CRITIQUE/MAJEUR/MINEUR), la ligne concernée, l'explication du problème, et une correction concrète.", format:"markdown structuré avec titres et bullet points", tone:"expert et technique, sans vulgarisation", example:"Input: `x = input()` | Output: [MAJEUR] Ligne 1 — Aucune validation d'entrée. Risque d'injection. Fix: `x = sanitize(input())`", constraints:"Pas de critique subjective, seulement des problèmes factuels avec correction", chips:["Chain of Thought"] },

  { id:2, name:"Générateur de contenu SEO", cat:"content", color:"#34d399", tag:"Contenu", desc:"Articles optimisés pour le référencement", role:"Rédacteur SEO expert avec 10 ans d'expérience en content marketing B2B", goal:"Rédiger un article de blog SEO-optimisé sur le sujet donné", context:"Cible : professionnels du secteur. Niveau de lecture : avancé. KPI visé : top 3 Google", task:"Rédige un article complet de 1500 mots sur le sujet. Inclus : hook d'introduction, H2/H3 avec mots-clés naturels, statistiques récentes, exemples concrets, CTA final.", format:"markdown structuré avec titres et bullet points", tone:"expert et technique, sans vulgarisation", example:"", constraints:"Pas de keyword stuffing, pas de contenu générique, chaque paragraphe apporte de la valeur", chips:["TL;DR first"] },

  { id:3, name:"Analyse de données / CSV", cat:"data", color:"#f59e0b", tag:"Data", desc:"Interprétation et insights de datasets", role:"Data analyst senior spécialisé en business intelligence et statistiques", goal:"Analyser les données fournies et extraire des insights actionnables", context:"Contexte business : identifier tendances, anomalies, et opportunités d'optimisation", task:"Analyse les données fournies. Donne : 1) Statistiques descriptives clés, 2) Top 3 insights business, 3) Anomalies détectées, 4) Recommandations actionnables priorisées.", format:"rapport exécutif synthétique", tone:"direct et concis, sans fioritures", example:"", constraints:"Chaque insight doit être chiffré, pas d'interprétation sans données", chips:["Hypothèses","Confiance"] },

  { id:4, name:"Agent de support client", cat:"agent", color:"#a78bfa", tag:"Agent", desc:"Réponses empathiques et solutions rapides", role:"Agent support client expert, empathique, avec accès à la base de connaissance produit", goal:"Résoudre le problème du client de façon rapide, claire et satisfaisante", context:"Produit SaaS B2B, clients techniques, SLA 4h. Prioriser la solution, pas les excuses.", task:"1) Reformule le problème pour confirmer ta compréhension. 2) Donne la solution pas-à-pas. 3) Préviens les problèmes futurs similaires. 4) Propose une ressource complémentaire.", format:"texte structuré avec examples concrets", tone:"pédagogique et clair, accessible à un débutant", example:"", constraints:"Jamais dire 'je ne sais pas', toujours proposer une alternative. Max 150 mots.", chips:["TL;DR first"] },

  { id:5, name:"Générateur de tests unitaires", cat:"code", color:"#60a5fa", tag:"Code", desc:"Suites de tests exhaustives et robustes", role:"QA Engineer senior expert en test-driven development et quality assurance", goal:"Générer une suite de tests unitaires complète pour le code fourni", context:"Framework : pytest. Objectif : couverture > 90%, inclure edge cases et cas limites", task:"Génère des tests unitaires pour chaque fonction. Pour chaque test : cas nominal, cas limites, cas d'erreur, mock si nécessaire. Ajoute des docstrings explicatives.", format:"code commenté", tone:"expert et technique, sans vulgarisation", example:"", constraints:"Chaque test doit avoir un nom descriptif. Pas de tests flaky. Assertions explicites.", chips:["Chain of Thought"] },

  { id:6, name:"Résumé exécutif", cat:"content", color:"#34d399", tag:"Contenu", desc:"Synthèses claires pour décideurs", role:"Consultant stratégique senior habitué à briefer des C-levels en 5 minutes", goal:"Produire un résumé exécutif percutant du document ou de la situation fournie", context:"Audience : direction générale, temps limité, besoin de décision rapide", task:"Synthèse en 3 sections : 1) Situation en 2 phrases. 2) Enjeux clés (3 bullet points max). 3) Recommandations avec impact attendu et effort estimé.", format:"rapport exécutif synthétique", tone:"direct et concis, sans fioritures", example:"", constraints:"Max 200 mots total. Pas de jargon. Chaque mot doit compter.", chips:["TL;DR first"] },

  { id:7, name:"Débogage d'erreur", cat:"code", color:"#60a5fa", tag:"Code", desc:"Diagnostic et correction d'erreurs rapide", role:"Ingénieur back-end senior, expert en debugging et analyse de stack traces", goal:"Diagnostiquer l'erreur fournie et proposer une correction testée", context:"Environnement de production, erreur reproductible, logs disponibles", task:"1) Identifie la cause racine (pas juste le symptôme). 2) Explique POURQUOI ça plante. 3) Donne la correction avec explication. 4) Préconise une mesure préventive.", format:"code commenté", tone:"expert et technique, sans vulgarisation", example:"", constraints:"Ne pas supposer — si manque d'info, liste exactement ce dont tu as besoin.", chips:["Chain of Thought","Hypothèses"] },

  { id:8, name:"Extraction de données structurées", cat:"data", color:"#f59e0b", tag:"Data", desc:"Parser et structurer tout type de contenu", role:"Ingénieur données expert en NLP et extraction d'information", goal:"Extraire et structurer les informations clés du contenu fourni", context:"Output doit être machine-readable, cohérent et complet", task:"Extrais les informations demandées du texte/document. Retourne un JSON strict avec les champs définis. Si une info est absente, mets null (pas de valeur inventée).", format:"JSON strict avec les clés définies", tone:"expert et technique, sans vulgarisation", example:'{"nom": "Jean Dupont", "email": "j@d.fr", "montant": 1200}', constraints:"Jamais inventer une valeur. null si absent. Format JSON valide uniquement.", chips:["XML output"] },

  { id:9, name:"Brainstorming d'idées", cat:"content", color:"#34d399", tag:"Contenu", desc:"Générer des idées originales et variées", role:"Creative director avec 20 ans d'expérience en innovation et design thinking", goal:"Générer des idées originales, variées et actionnables sur le sujet donné", context:"Chercher des idées non-conventionnelles, challenger les approches classiques", task:"Génère 10 idées : 3 incrémentales (améliorations), 4 disruptives (nouveauté), 3 far-fetched (folie). Pour chacune : idée en 1 ligne, potentiel, défi principal.", format:"liste numérotée", tone:"créatif et engageant", example:"", constraints:"Pas de redites, pas d'idées génériques. Chaque idée doit surprendre.", chips:["3 variantes","Auto-critique"] },

  { id:10, name:"Pipeline d'agent IA", cat:"agent", color:"#a78bfa", tag:"Agent", desc:"Architecture d'agents multi-étapes", role:"Architecte IA spécialisé en systèmes agentiques et orchestration LLM", goal:"Concevoir un pipeline d'agent IA pour accomplir la tâche complexe décrite", context:"Production-grade, fiable, avec gestion d'erreurs et rollback", task:"1) Décompose la tâche en sous-tâches atomiques. 2) Définis les outils nécessaires (input/output de chaque outil). 3) Décris la logique d'orchestration. 4) Identifie les points de défaillance et leur gestion.", format:"markdown structuré avec titres et bullet points", tone:"expert et technique, sans vulgarisation", example:"", constraints:"Chaque outil doit avoir interface définie. Pas d'ambiguïté dans les transitions.", chips:["Chain of Thought","Hypothèses","Confiance"] },

  { id:11, name:"Rédaction de documentation", cat:"content", color:"#34d399", tag:"Contenu", desc:"Docs techniques claires et complètes", role:"Technical writer senior, expert en documentation API et guides développeur", goal:"Rédiger une documentation technique complète et utilisable", context:"Audience : développeurs intermédiaires à seniors. Style : Stripe Docs, Vercel Docs", task:"Rédige la doc avec : overview (1 para), prérequis, installation pas-à-pas, usage de base (avec code), usage avancé, paramètres référence, erreurs courantes, FAQ.", format:"markdown structuré avec titres et bullet points", tone:"pédagogique et clair, accessible à un débutant", example:"", constraints:"Chaque étape doit être testable. Pas d'ambiguïté. Code toujours fonctionnel.", chips:["TL;DR first"] },

  { id:12, name:"Comparatif / benchmark", cat:"data", color:"#f59e0b", tag:"Data", desc:"Comparaisons factuelles et objectives", role:"Analyste technique objectif, expert en évaluation comparative de solutions", goal:"Produire un comparatif factuel et équilibré des options proposées", context:"Décision d'achat ou de choix technique à venir. Critères pondérés selon le contexte.", task:"Compare les options sur : performance, coût, facilité d'usage, scalabilité, support/communauté, intégration. Note /10 pour chaque critère. Conclusion avec recommandation contextualisée.", format:"tableau comparatif", tone:"direct et concis, sans fioritures", example:"", constraints:"Pas de biais vers une option. Chaque note justifiée. Sources si possible.", chips:["Confiance"] },
  { id:13, name:"Landing page", cat:"web", color:"#ec4899", tag:"Web", desc:"Création de pages d'atterrissage", role:"Designer UX/UI et développeur front-end senior, expert en conversion", goal:"Créer la structure et le contenu d'une landing page percutante", context:"Objectif : convertir les visiteurs. Cible et produit à préciser.", task:"Structure la page en sections (hero, problématique, solution, features, social proof, CTA). Pour chaque section : titre accrocheur, sous-titre, copy persuasif. Inclus des suggestions de visuels.", format:"markdown structuré avec titres et bullet points", tone:"créatif et engageant", example:"", constraints:"Mobile-first. 1 CTA principal par section. Pas de jargon.", chips:["TL;DR first"] },
  { id:14, name:"Site complet — brief", cat:"web", color:"#ec4899", tag:"Web", desc:"Génère le brief et les user stories d'un site", role:"Product owner et architecte technique expérimenté", goal:"Transformer une idée de site en brief détaillé et user stories actionnables", context:"Projet web à définir (e-commerce, SaaS, portfolio, blog…)", task:"1) Résume le projet en 3 phrases. 2) Liste les pages principales et leur objectif. 3) Génère 5-10 user stories au format : En tant que [persona], je veux [action] afin de [bénéfice]. 4) Propose une stack technique adaptée.", format:"markdown structuré avec titres et bullet points", tone:"direct et concis, sans fioritures", example:"", constraints:"User stories testables. Stack justifiée.", chips:["Hypothèses"] },
  { id:15, name:"Composant React/Next", cat:"web", color:"#ec4899", tag:"Web", desc:"Composants React/Next.js avec TypeScript", role:"Développeur React senior, expert TypeScript et Tailwind", goal:"Générer un composant React réutilisable et bien typé", context:"Framework : Next.js ou React. Style : Tailwind CSS.", task:"Crée un composant [nom] avec : props typées, hooks si besoin, classes Tailwind. Inclus JSDoc et exemples d'usage. Accessible (a11y).", format:"code commenté", tone:"expert et technique, sans vulgarisation", example:"", constraints:"Pas de any. Props explicites. Composant fonctionnel.", chips:["Chain of Thought"] },
  { id:16, name:"Portfolio / CV site", cat:"web", color:"#ec4899", tag:"Web", desc:"Structure et contenu pour portfolio ou CV en ligne", role:"Designer et rédacteur spécialisé personal branding", goal:"Créer la structure et les textes d'un site portfolio professionnel", context:"Profil professionnel à mettre en avant.", task:"Sections : accueil, à propos, projets (3-5 avec description), compétences, contact. Pour chaque section : textes percutants, suggestions de mise en page.", format:"markdown structuré avec titres et bullet points", tone:"professionnel et moderne", example:"", constraints:"Concise. Mettre en valeur les réalisations. CTA clair.", chips:[] },

  { id:17, name:"Email professionnel", cat:"content", color:"#34d399", tag:"Contenu", desc:"Emails clairs et percutants", role:"Rédacteur professionnel expert en communication B2B et emails à fort impact", goal:"Rédiger un email professionnel efficace pour la situation donnée", context:"Ton adapté au destinataire et à l'objectif (relance, pitch, remerciement, négociation).", task:"Rédige un email : objet accrocheur, salutation adaptée, corps en 3 paragraphes max, CTA clair, signature professionnelle. Inclus une version courte (3 lignes) pour relance.", format:"texte structuré avec objet et corps séparés", tone:"formel et professionnel", example:"", constraints:"Max 150 mots pour le corps. Pas de formules creuses. Direct au but.", chips:["TL;DR first"] },
  { id:18, name:"Post réseaux sociaux", cat:"content", color:"#34d399", tag:"Contenu", desc:"Contenu optimisé LinkedIn, X, Instagram", role:"Community manager senior avec expertise en storytelling et formats viraux", goal:"Créer un post engageant pour le réseau et l'objectif indiqués", context:"Cible, objectif (awareness, leads, communauté), ton de la marque.", task:"Génère : 1) Hook accrocheur (première ligne). 2) Corps du post avec structure lisible (paragraphes courts). 3) CTA. 4) 3-5 hashtags pertinents. 5) Variante courte si limite de caractères.", format:"texte structuré par sections", tone:"créatif et engageant", example:"", constraints:"Respecte les limites (LinkedIn ~1300, X 280, Instagram 2200). Pas de sur-optimisation hashtag.", chips:["3 variantes"] },
  { id:19, name:"Traduction & localisation", cat:"content", color:"#34d399", tag:"Contenu", desc:"Traductions natives et adaptées au contexte", role:"Traducteur professionnel bilingue expert en localisation et adaptatif culturel", goal:"Traduire le contenu en conservant le sens, le ton et les nuances culturelles", context:"Langue source et cible. Type de contenu (technique, marketing, juridique). Public cible.", task:"Traduis le texte fourni. Adapte les expressions idiomatiques, les références culturelles et le ton. Signale les ambiguïtés si nécessaire. Propose des alternatives pour les jeux de mots.", format:"texte traduit avec notes optionnelles", tone:"identique au source", example:"", constraints:"Ne pas inventer. Si une expression n'a pas d'équivalent, proposer une périphrase avec note.", chips:["Confiance"] },
  { id:20, name:"Refactoring de code", cat:"code", color:"#60a5fa", tag:"Code", desc:"Améliorer le code sans casser les fonctionnalités", role:"Architecte logiciel senior expert en clean code et design patterns", goal:"Refactoriser le code fourni pour améliorer lisibilité, maintenabilité et performance", context:"Langage et framework. Contraintes (rétro-compatibilité, tests existants).", task:"1) Analyse le code et identifie les smells. 2) Propose un plan de refactoring priorisé. 3) Applique les refactorings un par un avec explication. 4) Vérifie qu'aucune régression n'est introduite.", format:"code commenté avec explications", tone:"expert et technique, sans vulgarisation", example:"", constraints:"Pas de changement de comportement. Un refactoring = une amélioration isolée.", chips:["Chain of Thought"] },
  { id:21, name:"Nom de produit / marque", cat:"content", color:"#34d399", tag:"Contenu", desc:"Naming créatif et mémorable", role:"Naming strategist et branding expert avec 15 ans en création de marques", goal:"Générer des noms de produit ou de marque mémorables et distinctifs", context:"Secteur, cible, positionnement souhaité (premium, accessible, innovant).", task:"Génère 15 propositions de noms : 5 évocateurs, 5 inventés, 5 composés. Pour chaque nom : signification, associations, disponibilité probable (domaine .com), note de mémorabilité.", format:"liste avec colonnes nom / type / notes", tone:"créatif et engageant", example:"", constraints:"Noms prononçables en français. Pas de marques existantes connues. Vérifier les connotations négatives.", chips:["3 variantes","Auto-critique"] },
  { id:22, name:"Pitch deck / présentation", cat:"content", color:"#34d399", tag:"Contenu", desc:"Structure de pitch investisseurs ou clients", role:"Consultant startup et expert en storytelling B2B, habitué aux pitchs Seed/Series A", goal:"Créer la structure et le contenu d'un pitch deck percutant", context:"Type de pitch (investisseurs, client corporate, partenariat). Durée cible.", task:"Structure en 10-12 slides : problème, solution, marché, modèle, traction, équipe, demande, contact. Pour chaque slide : titre accrocheur, 3 bullet points max, suggestion visuelle.", format:"markdown avec une section par slide", tone:"direct et convaincant", example:"", constraints:"1 idée par slide. Chiffres quand possible. Pas de jargon.", chips:["TL;DR first"] },
  { id:23, name:"Fiche produit e-commerce", cat:"content", color:"#34d399", tag:"Contenu", desc:"Descriptions produit vendeuses et SEO", role:"Rédacteur e-commerce expert en conversion et SEO produit", goal:"Rédiger une fiche produit optimisée pour la vente et le référencement", context:"Type de produit, cible, avantages concurrentiels, contraintes légales (claims).", task:"Génère : 1) Titre produit (60 car. max, mots-clés). 2) Sous-titre accrocheur. 3) Description courte (3 benefits). 4) Description longue avec specs, avantages, usage. 5) Points bullets SEO.", format:"sections distinctes titre / short / long / bullets", tone:"vendeur sans être agressif", example:"", constraints:"Pas de superlatifs non prouvés. Respecte les réglementations publicitaires.", chips:["TL;DR first"] },
  { id:24, name:"FAQ automatique", cat:"content", color:"#34d399", tag:"Contenu", desc:"Questions-réponses à partir d'un document", role:"Rédacteur technique expert en documentation utilisateur et support", goal:"Générer une FAQ à partir du document ou du produit fourni", context:"Type de document (technique, commercial, onboarding). Public cible.", task:"Extrais les 10-15 questions les plus probables que les utilisateurs se poseraient. Pour chacune : question formulée naturellement, réponse courte et claire, lien vers section du doc si pertinent.", format:"liste Q/R avec questions en gras", tone:"pédagogique et clair", example:"", constraints:"Réponses factuelles uniquement. Pas d'invention. Réponse max 80 mots.", chips:[] },
  { id:25, name:"Lettre de motivation", cat:"content", color:"#34d399", tag:"Contenu", desc:"Lettres personnalisées et percutantes", role:"Coach carrière et rédacteur RH expert en candidatures", goal:"Rédiger une lettre de motivation personnalisée et convaincante", context:"Poste ciblé, entreprise, profil du candidat (CV résumé).", task:"Rédige une lettre en 3 parties : 1) Accroche liant ton profil au poste. 2) Pourquoi cette entreprise + preuves concrètes. 3) CTA et disponibilité. Ton professionnel mais personnel.", format:"lettre formelle structurée", tone:"professionnel et engageant", example:"", constraints:"Max 250 mots. Pas de formules génériques. Chaque phrase doit apporter.", chips:[] },
  { id:26, name:"Plan marketing", cat:"content", color:"#34d399", tag:"Contenu", desc:"Stratégie marketing structurée", role:"Consultant marketing senior avec expertise growth et canaux digitaux", goal:"Élaborer un plan marketing actionnable pour l'objectif donné", context:"Produit/service, budget, horizon, canaux préférés.", task:"Structure le plan : 1) Objectifs SMART. 2) Cibles et personas. 3) Proposition de valeur. 4) Canaux et tactiques (3-5). 5) Calendrier recommandé. 6) KPIs et métriques. 7) Budget indicatif par canal.", format:"markdown structuré avec titres et tableaux", tone:"direct et actionnable", example:"", constraints:"Chiffres réalistes. Prioriser l'impact. Pas de jargon inutile.", chips:["Chain of Thought","Hypothèses"] },
  { id:27, name:"Tutoriel / formation", cat:"content", color:"#34d399", tag:"Contenu", desc:"Guides pas-à-pas pédagogiques", role:"Formateur technique expert en pédagogie et andragogie", goal:"Créer un tutoriel clair et progressif pour apprendre la compétence donnée", context:"Niveau du public (débutant, intermédiaire, avancé). Durée estimée.", task:"Structure le tutoriel : 1) Prérequis. 2) Objectifs d'apprentissage. 3) Étapes numérotées avec explication + code/commande si pertinent. 4) Points de vigilance. 5) Exercice pratique. 6) Ressources pour aller plus loin.", format:"markdown avec étapes clairement séparées", tone:"pédagogique et clair", example:"", constraints:"Chaque étape doit être testable. Pas de saut de logique.", chips:["Chain of Thought"] },
  { id:28, name:"Script vidéo YouTube", cat:"content", color:"#34d399", tag:"Contenu", desc:"Scripts pour vidéos YouTube engageantes", role:"Créateur de contenu YouTube expert en rétention et storytelling vidéo", goal:"Écrire un script de vidéo optimisé pour l'engagement et la rétention", context:"Type de vidéo (tuto, vlog, explication). Durée cible. Ton (fun, pro, éducatif).", task:"Génère un script avec : 1) Hook (10-15 sec) qui accroche. 2) Intro qui pose la promesse. 3) Plan en 3-5 parties. 4) Corps avec transitions entre parties. 5) CTA (like, abonne-toi, commente). Indique le temps estimé par section.", format:"script avec repères temporels", tone:"adapté au format vidéo", example:"", constraints:"Phrases courtes pour la parole. Éviter les formulations écrites.", chips:["TL;DR first"] },
  { id:29, name:"Offre d'emploi / job description", cat:"content", color:"#34d399", tag:"Contenu", desc:"Descriptions de poste attractives et précises", role:"Recruteur et rédacteur RH expert en employer branding", goal:"Rédiger une offre d'emploi attractive et informative", context:"Poste, entreprise, type de contrat, localisation.", task:"Rédige une offre : 1) Titre accrocheur. 2) Présentation entreprise (2-3 lignes). 3) Missions (5-7 bullets). 4) Profil recherché (hard + soft skills). 5) Ce qu'on offre. 6) Process de recrutement. 7) CTA.", format:"sections clairement délimitées", tone:"professionnel et engageant", example:"", constraints:"Pas de biais (âge, genre). Critères mesurables. Inclusive.", chips:[] },
  { id:30, name:"Résumé de meeting / compte-rendu", cat:"content", color:"#34d399", tag:"Contenu", desc:"Synthèse de réunion actionnable", role:"Assistant de direction expert en prise de notes et synthèse", goal:"Produire un compte-rendu clair et actionnable à partir des notes de réunion", context:"Type de réunion (projet, décision, one-to-one). Participants.", task:"Structure le CR : 1) Date, participants, objectif. 2) Points abordés par thème. 3) Décisions prises. 4) Actions avec responsable et deadline. 5) Prochaines étapes. 6) Points ouverts.", format:"sections avec liste d'actions en gras", tone:"factuel et neutre", example:"", constraints:"Pas d'interprétation. Seulement les faits et décisions. Actions SMART.", chips:["TL;DR first"] },
  { id:31, name:"Analyse de sentiment", cat:"data", color:"#f59e0b", tag:"Data", desc:"Analyse du ton et des émotions dans un texte", role:"Data scientist spécialisé en NLP et analyse de sentiment", goal:"Analyser le sentiment et les émotions exprimés dans le texte fourni", context:"Type de texte (avis client, réseau social, support). Granularité souhaitée.", task:"Pour chaque segment pertinent : 1) Sentiment global (positif/négatif/neutre) avec score. 2) Émotions détectées (joie, colère, surprise…). 3) Mots-clés porteurs. 4) Recommandation d'action si applicable.", format:"tableau ou liste structurée", tone:"factuel et objectif", example:"", constraints:"Pas de sur-interprétation. Citer les éléments du texte.", chips:["Confiance"] },
  { id:32, name:"Génération SQL / requêtes", cat:"code", color:"#60a5fa", tag:"Code", desc:"Requêtes SQL optimisées et documentées", role:"DBA et développeur SQL senior expert en optimisation", goal:"Générer des requêtes SQL correctes et performantes pour le besoin décrit", context:"SGBD (PostgreSQL, MySQL, etc.). Schéma des tables fourni.", task:"Écris la requête SQL demandée. Inclus : 1) Commentaires expliquant la logique. 2) Index recommandés si pertinent. 3) Variante optimisée si applicable. 4) Points d'attention (N+1, full scan).", format:"code SQL commenté", tone:"expert et technique", example:"", constraints:"SQL valide et exécutable. Respecte le schéma. Pas de SELECT * en prod.", chips:["Chain of Thought"] },
  { id:33, name:"Agent de recherche", cat:"agent", color:"#a78bfa", tag:"Agent", desc:"Recherche et synthèse d'infos", role:"Agent de recherche expert avec accès à des sources fiables", goal:"Rechercher des informations sur un sujet et synthétiser une réponse factuelle", context:"Sources à privilégier. Niveau de détail attendu.", task:"1) Identifie les sources pertinentes. 2) Extrais les faits clés. 3) Synthétise en réponse structurée. 4) Cite les sources. 5) Indique ton niveau de confiance par affirmation.", format:"markdown avec sections et citations", tone:"factuel et neutre", example:"", constraints:"Pas d'invention. Si info manquante, dis-le. Distingue fait et opinion.", chips:["Confiance","Hypothèses"] },
  { id:34, name:"Agent de prise de notes", cat:"agent", color:"#a78bfa", tag:"Agent", desc:"Notes structurées à partir de contenu", role:"Assistant de prise de notes expert en synthèse et structuration", goal:"Transformer un contenu (audio transcrypt, réunion, article) en notes actionnables", context:"Type de contenu. Format de sortie souhaité.", task:"1) Résume les points clés. 2) Extrais les décisions et actions. 3) Liste les questions ouvertes. 4) Crée une structure navigable (titres, bullets). 5) Mets en évidence les deadlines et responsables.", format:"markdown structuré avec sections", tone:"factuel et concis", example:"", constraints:"Pas de paraphrase vide. Chaque point doit être actionnable ou informatif.", chips:["TL;DR first"] },
  { id:35, name:"Agent de réservation / RDV", cat:"agent", color:"#a78bfa", tag:"Agent", desc:"Gestion de créneaux et rendez-vous", role:"Agent de scheduling expert en gestion de calendrier et négociation de créneaux", goal:"Aider à planifier ou proposer des créneaux de rendez-vous", context:"Contraintes (disponibilités, durée, type de RDV).", task:"1) Comprendre la demande (qui, quand, durée, type). 2) Proposer 3 créneaux possibles avec justification. 3) Reformuler pour confirmation. 4) Gérer les conflits ou alternatives. 5) Résumer le RDV confirmé.", format:"texte structuré avec créneaux en liste", tone:"professionnel et clair", example:"", constraints:"Toujours proposer des alternatives. Jamais assumer sans confirmer. Format date/heure explicite.", chips:["Hypothèses"] }
];

const LENGTH_LABELS = ["Très court (< 100 mots)", "Court (100-300 mots)", "Moyen (300-600 mots)", "Long (600-1200 mots)", "Très long (1200+ mots)"];
const API_KEY_KEY = 'promptforge-api-key';
const THEME_KEY = 'promptforge-theme';
const ONBOARDING_KEY = 'promptforge-onboarding-done';
const PINNED_KEY = 'promptforge-pinned-templates';
let currentCat = "all", history = [], generating = false;

function getApiKey() { return localStorage.getItem(API_KEY_KEY) || ''; }
function getAnthropicHeaders() {
  const key = getApiKey();
  return {
    'Content-Type': 'application/json',
    'x-api-key': key,
    'anthropic-version': '2023-06-01'
  };
}

const GLOSSARY = [
  { term: "LLM", def: "Large Language Model. Modèle de langage entraîné sur d'énormes volumes de texte, capable de générer du texte cohérent. Ex : GPT-4, Claude, Llama." },
  { term: "Token", def: "Unité de texte traitée par le modèle (≈ 4 caractères en français). 1000 tokens ≈ 750 mots. Les APIs facturent au token." },
  { term: "Prompt", def: "Texte ou instructions envoyés au LLM pour guider sa réponse. Le prompt engineering vise à optimiser ces instructions." },
  { term: "Context window", def: "Taille max du contexte (prompt + réponse). 128K = ~100 pages. Plus c'est grand, plus tu peux inclure de doc ou d'exemples." },
  { term: "Chain of Thought (CoT)", def: "Technique consistant à demander au modèle de « penser étape par étape » avant de répondre. Améliore le raisonnement sur tâches complexes." },
  { term: "Few-shot", def: "Fournir 1 à 5 exemples input→output dans le prompt pour calibrer le format et le style de réponse." },
  { term: "RAG", def: "Retrieval-Augmented Generation. Récupère des documents pertinents avant d'appeler le LLM, pour enrichir le contexte avec des infos à jour." },
  { term: "Fine-tuning", def: "Réentraînement du modèle sur des données spécifiques pour adapter son comportement. Coûteux, alternatif : prompt + RAG." },
  { term: "Hallucination", def: "Le modèle génère des infos factuellement fausses ou inventées. Réduire via : exemples, sources, demander d'exprimer l'incertitude." },
  { term: "Embedding", def: "Représentation vectorielle d'un texte. Utilisé pour recherche sémantique, RAG, similarité entre documents." },
  { term: "System prompt", def: "Instructions globales fixant le rôle et le comportement du modèle (souvent invisible pour l'utilisateur)." },
  { term: "Temperature", def: "Paramètre contrôlant la randomité (0 = déterministe, 1 = créatif). Bas pour code/factuel, haut pour créatif." }
];

const BONNES_PRATIQUES = `
<h3>1. Rôle précis</h3>
<p><strong>Éviter :</strong> "Tu es un assistant."</p>
<p><strong>Préférer :</strong> "Tu es un senior développeur Python avec 10 ans d'expérience en systèmes distribués, expert en FastAPI et PostgreSQL."</p>
<p>Un rôle détaillé ancre le modèle dans un point de vue et un niveau d'expertise cohérents.</p>

<h3>2. Format de sortie explicite</h3>
<p>Indique toujours comment tu veux la réponse : JSON, liste numérotée, markdown avec titres, tableau, etc. Exemple : "Réponds en JSON avec les clés : titre, résumé, mots_clés."</p>

<h3>3. Exemples (few-shot)</h3>
<p>Un seul exemple input→output vaut mieux que 10 lignes d'instructions. Pour des formats stricts (JSON, XML), 1-2 exemples suffisent.</p>

<h3>4. Contraintes claires</h3>
<p>"En 3 points maximum", "sans jargon", "max 200 mots", "ne pas inventer de chiffres". Les contraintes limitent les dérives.</p>

<h3>5. Chain of Thought pour le raisonnement</h3>
<p>Pour les tâches complexes (math, logique, debug), ajoute : "Pense étape par étape avant de répondre." ou "Show your reasoning."</p>

<h3>6. Gérer l'incertitude</h3>
<p>Demande au modèle d'indiquer quand il n'est pas sûr : "Si tu ne connais pas la réponse, dis-le explicitement."</p>

<h3>7. Structurer en sections</h3>
<p>Utilise ## Rôle, ## Objectif, ## Tâche, ## Format pour que le modèle parse facilement ton prompt.</p>
`;

const GUIDE_BUILDER = `
<h3>Rôle</h3>
<p>Définit qui est l'assistant IA : son expertise, son niveau, ses spécialités. Plus le rôle est précis (ex : "Senior développeur Python avec 10 ans d'expérience en FastAPI"), plus les réponses seront pertinentes et cohérentes.</p>

<h3>Objectif</h3>
<p>Ce que tu veux obtenir en une phrase. Ex : "Auditer ce code Python et identifier les vulnérabilités." L'objectif donne la direction générale du prompt.</p>

<h3>Tâche</h3>
<p>Les instructions détaillées : comment procéder, quelles étapes suivre, quel format de réponse attendre. Décris précisément ce que tu attends pour éviter les réponses trop vagues.</p>

<h3>Contexte</h3>
<p>Informations utiles pour adapter la réponse : stack technique, contraintes business, environnement (prod, dev), audience cible. Enrichit la compréhension du modèle.</p>

<h3>Format de sortie</h3>
<p>Le type de réponse souhaitée : JSON, markdown, liste numérotée, tableau, code commenté, rapport exécutif… Un format explicite réduit les surprises et facilite le traitement.</p>

<h3>Langue de sortie</h3>
<p>Permet de forcer la langue de la réponse (FR, EN, ES, DE) indépendamment de la langue du prompt.</p>

<h3>Ton / Style</h3>
<p>Le registre de la réponse : expert technique, pédagogique, direct, créatif, formel, conversationnel. Adapte le ton à ton audience.</p>

<h3>Exemple(s) souhaité(s)</h3>
<p>Un ou plusieurs exemples input→output. Très efficace pour calibrer le format et le style. 1 exemple peut valoir 10 lignes d'instructions.</p>

<h3>Contraintes / Ce qu'il ne faut pas faire</h3>
<p>Limites à respecter : "Pas de jargon", "max 200 mots", "ne pas inventer de chiffres". Évite les dérives et garde le contrôle sur la sortie.</p>

<h3>Variables dynamiques</h3>
<p>Format : <code>nom: valeur</code> séparés par <code>|</code>. Utilise <code>{{nom}}</code> dans le prompt pour des valeurs réutilisables. Ex : <code>sujet: landing page | client: startup B2B</code> puis <code>Rédige une {{sujet}} pour {{client}}</code>.</p>

<h3>Techniques</h3>
<p>Méthodes avancées de prompt engineering : Chain of Thought (raisonnement étape par étape), Hypothèses, Confiance, TL;DR first, Auto-critique, Analogies… Chaque technique ajoute une instruction spécifique au prompt.</p>

<h3>Snippets web</h3>
<p>Instructions prédéfinies à insérer dans la tâche : Sections HTML5, Tailwind CSS, React + TypeScript, Mobile-first, User stories… Clique pour ajouter au champ Tâche.</p>

<h3>Longueur</h3>
<p>Contrôle la longueur souhaitée de la réponse : très courte à très détaillée. Influence le niveau de détail du modèle.</p>
`;

function downloadCheatSheet() {
  const html = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>PromptForge — Cheat Sheet</title><style>body{font-family:system-ui;max-width:700px;margin:2rem auto;padding:1rem;line-height:1.6;color:#1a1a1a} h1{font-size:1.4rem;border-bottom:2px solid #6c63ff;padding-bottom:0.5rem} h2{font-size:1rem;margin-top:1.5rem;color:#333} ul{margin:0.5rem 0;padding-left:1.5rem} li{margin:0.3rem 0} code{background:#f0f0f0;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.9em} .tip{background:#f8f9fa;padding:0.8rem;margin:0.5rem 0;border-radius:8px;border-left:4px solid #6c63ff} @media print{body{margin:0;padding:1rem}}</style></head><body>
<h1>📋 Cheat Sheet — Prompt Engineering</h1>
<p><em>Généré par PromptForge</em></p>
<h2>Structure type</h2>
<pre>## Rôle
Tu es [expertise précise].

## Objectif
[Ce que tu veux obtenir]

## Contexte
[Infos utiles]

## Tâche
[Détails, étapes]

## Format de sortie
[JSON, markdown, liste...]

## Contraintes
[max mots, ton, interdictions]</pre>
<h2>Techniques clés</h2>
<ul><li><strong>Rôle précis</strong> — Spécialisation, années d'expérience</li>
<li><strong>Exemples (few-shot)</strong> — 1 exemple = 10x plus efficace</li>
<li><strong>Chain of Thought</strong> — "Pense étape par étape"</li>
<li><strong>Variables</strong> — <code>{{sujet}}</code> dans le texte</li>
<li><strong>Format explicite</strong> — Toujours préciser le format attendu</li></ul>
<h2>Variables dynamiques</h2>
<p>Format : <code>nom: valeur</code> séparés par <code>|</code>. Utilise <code>{{nom}}</code> dans le prompt.</p>
<h2>Ressources</h2>
<p>Anthropic • OpenAI • Google AI • Mistral • Llama (Meta)</p>
<p style="margin-top:2rem;font-size:0.85rem;color:#666">promptforge — forge des prompts qui déchirent</p>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'promptforge-cheatsheet.html'; a.click(); URL.revokeObjectURL(a.href);
}

const RESOURCES = [
  { title: "Anthropic Documentation", url: "https://docs.anthropic.com", desc: "Docs officielles Claude, bonnes pratiques, safety." },
  { title: "OpenAI Cookbook", url: "https://cookbook.openai.com", desc: "Recettes et exemples pour l'API OpenAI." },
  { title: "Prompt Engineering Guide", url: "https://www.promptingguide.ai", desc: "Guide complet du prompt engineering (DAIR)." },
  { title: "Learn Prompting", url: "https://learnprompting.org", desc: "Cours gratuit et interactif." },
  { title: "Google AI for Developers", url: "https://ai.google.dev", desc: "Gemini API, guides, exemples." },
  { title: "Mistral AI Docs", url: "https://docs.mistral.ai", desc: "Documentation Mistral et modèles open." },
  { title: "Llama (Meta)", url: "https://llama.meta.com", desc: "Modèles open-source, API, ressources." }
];

// ── APIs IA ──
const API_LIST = [
  {
    id: 'anthropic',
    name: 'Claude',
    provider: 'Anthropic',
    logo: 'brain',
    logoBg: 'rgba(217,119,6,0.2)',
    desc: 'Modèles optimisés pour la sécurité, le raisonnement et les longues conversations. Prompt caching et batch disponibles.',
    models: [
      { name: 'Claude Opus 4.6', in: '$5', out: '$25', ctx: '1M tokens' },
      { name: 'Claude Sonnet 4.5', in: '$3', out: '$15', ctx: '1M tokens' },
      { name: 'Claude Haiku 4.5', in: '$1', out: '$5', ctx: '200K tokens' }
    ],
    meta: 'Contexte 1M sur Opus/Sonnet • Batch -50% • Cache -90%',
    strengths: 'Idéal pour : raisonnement complexe, analyse de documents longs, applications sensibles (safety-by-design), agents conversationnels.',
    link: 'https://docs.anthropic.com',
    badges: ['popular'],
    keywords: ['raisonnement','complexe','document long','sécurité','safety','agent','conversationnel','analyse','réflexion','réfléchir']
  },
  {
    id: 'openai',
    name: 'GPT',
    provider: 'OpenAI',
    logo: 'bot',
    logoBg: 'rgba(16,185,129,0.2)',
    desc: 'Référence du marché. GPT-4o et GPT-5 pour des tâches variées. Écosystème mature (plugins, fonction calling, vision).',
    models: [
      { name: 'GPT-5.2', in: '~$2.50', out: '~$10', ctx: '128K+' },
      { name: 'GPT-4o', in: '$2.50', out: '$10', ctx: '128K' },
      { name: 'GPT-4o mini', in: '$0.15', out: '$0.60', ctx: '128K' }
    ],
    meta: 'Batch -50% • Cache -90% • Web search, file search',
    strengths: 'Idéal pour : intégrations multiples (ChatGPT), code (Cursor, Copilot), créativité, vision, fonction calling.',
    link: 'https://platform.openai.com/docs',
    badges: ['popular'],
    keywords: ['code','coder','chatbot','intégration','créativité','vision','image','chatgpt','cursor','copilot','polyvalent','contenu','seo','article','texte','écrire','créer']
  },
  {
    id: 'google',
    name: 'Gemini',
    provider: 'Google',
    logo: 'gem',
    logoBg: 'rgba(59,130,246,0.2)',
    desc: 'Contexte massif (1M tokens). Modèles variés du budget à l\'entreprise. Intégration native Google Cloud.',
    models: [
      { name: 'Gemini 2.5 Pro', in: '$1.25', out: '$10', ctx: '1M tokens' },
      { name: 'Gemini 2.5 Flash', in: '$0.30', out: '$2.50', ctx: '1M tokens' },
      { name: 'Gemini 2.5 Flash-Lite', in: '$0.10', out: '$0.40', ctx: '1M tokens' }
    ],
    meta: 'Contexte 1M • Batch -50% • Cache jusqu\'à -90%',
    strengths: 'Idéal pour : gros volumes de texte, analyse de documents, code (Gemini 2.5 Pro), coût réduit (Flash-Lite).',
    link: 'https://ai.google.dev/gemini-api/docs',
    badges: ['free'],
    keywords: ['document','volume','gros texte','contexte long','code','gratuit','bon marché','moins cher','analyse','données','contenu','résumé']
  },
  {
    id: 'mistral',
    name: 'Mistral',
    provider: 'Mistral AI',
    logo: 'zap',
    logoBg: 'rgba(245,158,11,0.2)',
    desc: 'Performances proches de GPT-4 à moindre coût. Modèles open (Llama) et propriétaires. Hébergement EU disponible.',
    models: [
      { name: 'Mistral Large 24', in: '$2', out: '$6', ctx: '128K' },
      { name: 'Mistral Medium 3', in: '$0.40', out: '$2', ctx: '128K' },
      { name: 'Mistral Small 3.1', in: '$0.10', out: '$0.30', ctx: '128K' },
      { name: 'Codestral', in: '$0.20', out: '$0.60', ctx: '128K' }
    ],
    meta: 'Tier gratuit 500K tokens/mois • Multi-langue',
    strengths: 'Idéal pour : budget serré, Europe (RGPD), code (Codestral), bon ratio qualité/prix.',
    link: 'https://docs.mistral.ai',
    badges: ['free'],
    keywords: ['budget','pas cher','économique','europe','rgpd','france','code','codestral','qualité prix','moins cher','chatbot','contenu']
  },
  {
    id: 'llama',
    name: 'Llama',
    provider: 'Meta',
    logo: 'layers',
    logoBg: 'rgba(59,130,246,0.2)',
    desc: 'Modèles open-source de Meta. API officielle avec Llama 3.1, 3.2, 3.3 et Llama 4. Contexte jusqu\'à 1M tokens (Maverick).',
    models: [
      { name: 'Llama 4 Maverick', in: '$0.15', out: '$0.60', ctx: '1M tokens' },
      { name: 'Llama 4 Scout', in: '$0.08', out: '$0.30', ctx: '128K' },
      { name: 'Llama 3.3 70B', in: '$0.10', out: '$0.32', ctx: '128K' },
      { name: 'Llama 3.1 8B', in: '$0.02', out: '$0.05', ctx: '128K' },
      { name: 'Llama 3.2 3B', in: '$0.02', out: '$0.02', ctx: '32K' }
    ],
    meta: 'Open-source • Multimodal (Maverick) • Llama Guard (safety)',
    strengths: 'Idéal pour : coût très bas, self-hosting possible, confidentialité, modèles légers (3B, 8B) ou gros (405B via API).',
    link: 'https://llama.meta.com',
    badges: ['free'],
    keywords: ['gratuit','open source','confidentialité','self-host','local','léger','petit modèle','coût bas','meta']
  },
  {
    id: 'xai',
    name: 'Grok',
    provider: 'xAI',
    logo: 'sparkles',
    logoBg: 'rgba(139,92,246,0.2)',
    desc: 'Modèles puissants avec accès temps réel à X (Twitter). Grok-4 pour le raisonnement, Grok-Code pour le code.',
    models: [
      { name: 'Grok 4.1', in: '~$2', out: '~$10', ctx: '128K' },
      { name: 'Grok 4.1 Fast', in: '$0.20', out: '$0.50', ctx: '128K' },
      { name: 'Grok-Code-Fast', in: '—', out: '—', ctx: 'Code' }
    ],
    meta: 'Web search • Voice agents • Fichiers & batch',
    strengths: 'Idéal pour : contenu temps réel, actualités, recherche X, agents avec accès web.',
    link: 'https://docs.x.ai',
    badges: [],
    keywords: ['temps réel','actualité','x twitter','recherche web','web search','live']
  },
  {
    id: 'cohere',
    name: 'Command',
    provider: 'Cohere',
    logo: 'globe',
    logoBg: 'rgba(236,72,153,0.2)',
    desc: 'Spécialisé RAG, embedding, classification. Command pour la génération. Offre entreprise solide.',
    models: [
      { name: 'Command R+', in: '~$1.50', out: '~$2', ctx: '128K' },
      { name: 'Command R', in: '~$0.50', out: '~$1.50', ctx: '128K' },
      { name: 'Command', in: '~$0.15', out: '~$0.60', ctx: '4K' }
    ],
    meta: 'RAG optimisé • Embeddings • Multi-langue',
    strengths: 'Idéal pour : RAG, recherche sémantique, classification, entreprises (souveraineté données).',
    link: 'https://docs.cohere.com',
    badges: [],
    keywords: ['rag','recherche','embedding','classification','entreprise','sémantique']
  },
  {
    id: 'groq',
    name: 'Groq',
    provider: 'Groq',
    logo: 'rocket',
    logoBg: 'rgba(239,68,68,0.2)',
    desc: 'Inférence ultra-rapide (LPU). Idéal pour la latence. Llama, Mixtral et modèles Groq en accès direct.',
    models: [
      { name: 'Llama 3.3 70B', in: 'gratuit', out: 'gratuit', ctx: '128K' },
      { name: 'Llama 3.1 8B', in: 'gratuit', out: 'gratuit', ctx: '128K' },
      { name: 'Mixtral 8x7B', in: 'gratuit', out: 'gratuit', ctx: '32K' }
    ],
    meta: 'Latence < 1 s • Tier gratuit généreux',
    strengths: 'Idéal pour : temps réel, chatbots, applications où la vitesse prime sur le coût.',
    link: 'https://console.groq.com/docs',
    badges: ['free'],
    keywords: ['rapide','vitesse','latence','temps réel','chatbot','gratuit','llama','instantané']
  }
];

function recommendApi() {
  const q = (document.getElementById('api-need-input')?.value || '').toLowerCase().trim();
  const result = document.getElementById('recommended-result');
  const cards = document.getElementById('recommended-cards');
  if (!q) { showToast('Décris ce que tu veux faire', true); return; }
  const words = q.split(/\s+/).filter(w => w.length > 2);
  const scores = API_LIST.map(api => {
    const kw = (api.keywords || []).join(' ').toLowerCase();
    const str = (api.name + ' ' + api.provider + ' ' + api.strengths + ' ' + api.desc).toLowerCase();
    const all = kw + ' ' + str;
    let score = 0;
    words.forEach(w => {
      if (all.includes(w)) score += 2;
      if (kw.includes(w)) score += 3;
    });
    return { api, score };
  });
  scores.sort((a, b) => b.score - a.score);
  let top = scores.filter(s => s.score > 0).slice(0, 3);
  if (top.length === 0) {
    top = scores.slice(0, 3).map(s => ({ ...s, score: 1 }));
    cards.innerHTML = '<p style="font-size:0.8rem;color:var(--muted);margin-bottom:0.8rem">Pas de match précis. Voici des APIs polyvalentes :</p>' + top.map((s, i) => {
      const a = s.api;
      return `<div class="rec-card"><div class="api-card-logo" style="background:${a.logoBg};width:40px;height:40px;display:flex;align-items:center;justify-content:center"><i data-lucide="${a.logo}" style="width:20px;height:20px"></i></div><div><strong>${a.name}</strong> (${a.provider})<div class="rec-card-reason">${a.strengths.split('Idéal pour : ')[1]?.split('.')[0] || a.strengths}</div><a href="${a.link}" target="_blank" class="api-card-link" style="margin-top:0.5rem">Voir la doc</a></div></div>`;
    }).join('');
  } else {
    cards.innerHTML = top.map((s, i) => {
      const a = s.api;
      const reason = i === 0 ? 'Meilleur match pour ton besoin' : 'Alternative adaptée';
      return `<div class="rec-card"><div class="api-card-logo" style="background:${a.logoBg};width:40px;height:40px;display:flex;align-items:center;justify-content:center"><i data-lucide="${a.logo}" style="width:20px;height:20px"></i></div><div><strong>${a.name}</strong> (${a.provider})<div class="rec-card-reason">${reason} — ${a.strengths.split('Idéal pour : ')[1]?.split('.')[0] || a.strengths}</div><a href="${a.link}" target="_blank" class="api-card-link" style="margin-top:0.5rem">Voir la doc</a></div></div>`;
    }).join('');
  }
  result.style.display = 'block';
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

// ── INIT ──
function init() {
  renderTemplates();
  setupCatTabs();
  setupTabs();
  setupSearch();
  setupCharCounters();
  setupViewNav();
  renderApis();
  renderGlossary();
  renderBonnesPratiques();
  renderGuideBuilder();
  renderRessources();
  renderLibrary();
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function setupViewNav() {
  document.querySelectorAll('.header-nav-btn[data-view]').forEach(btn => {
    btn.addEventListener('click', (e) => { if (btn.dataset.view) navTo(btn.dataset.view); });
  });
}
function toggleDropdown() {
  document.getElementById('dropdown-nav').classList.toggle('open');
}
function navTo(view) {
  document.getElementById('dropdown-nav')?.classList.remove('open');
  document.querySelectorAll('.header-nav-btn').forEach(b => b.classList.remove('active'));
  const subViews = ['glossaire','bonnes-pratiques','ressources','bibliotheque','guide-builder'];
  const btn = document.querySelector(`.header-nav-btn[data-view="${view}"]`);
  if (btn) btn.classList.add('active');
  else if (subViews.includes(view)) document.querySelector('#dropdown-nav .header-nav-btn')?.classList.add('active');
  document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('view-' + view);
  if (el) el.classList.add('active');
}

let simpleMode = true;
function setMode(mode) {
  simpleMode = (mode === 'simple');
  document.getElementById('mode-simple').classList.toggle('active', simpleMode);
  document.getElementById('mode-complet').classList.toggle('active', !simpleMode);
  document.getElementById('block-options').classList.toggle('collapsed', simpleMode);
  document.getElementById('block-expert').classList.toggle('collapsed', simpleMode);
  document.querySelector('[data-block="block-options"]')?.classList.toggle('expanded', !simpleMode);
  document.querySelector('[data-block="block-expert"]')?.classList.toggle('expanded', !simpleMode);
}
function toggleTips() {
  const c = document.getElementById('tip-card');
  const t = document.getElementById('tip-toggle');
  c.classList.toggle('collapsed');
  t.textContent = c.classList.contains('collapsed') ? 'Voir plus de conseils' : 'Voir moins';
}
function toggleBlock(id) {
  const block = document.getElementById(id);
  const t = document.querySelector('[data-block="' + id + '"]');
  block?.classList.toggle('collapsed');
  t?.classList.toggle('expanded', !block?.classList.contains('collapsed'));
}
function fillExample() {
  document.getElementById('f-role').value = 'Expert développeur senior avec 10 ans d\'expérience';
  document.getElementById('f-goal').value = 'Analyser et améliorer le code fourni';
  document.getElementById('f-task').value = '1) Identifie les problèmes (bugs, performance, sécurité)\n2) Pour chaque problème : explication courte + correction proposée\n3) Priorise par criticité';
  liveScore();
  showToast('Exemple rempli — modifie à ta guise');
}
function insertSnippet(el) {
  const task = document.getElementById('f-task');
  const snip = el.dataset.snippet;
  task.value = (task.value ? task.value + '\n\n' : '') + snip;
  liveScore();
  showToast('Snippet ajouté');
}

function parseVariables() {
  const raw = document.getElementById('f-vars')?.value?.trim() || '';
  const vars = {};
  raw.split('|').forEach(pair => {
    const [k, v] = pair.split(':').map(s => s?.trim());
    if (k && v) vars[k] = v;
  });
  return vars;
}
function applyVariables(text, vars) {
  if (!vars || !text) return text;
  return text.replace(/\{\{(\w+)\}\}/g, (_, k) => vars[k] ?? '{{' + k + '}}');
}

function renderApis() {
  const grid = document.getElementById('api-grid');
  grid.innerHTML = API_LIST.map(api => `
    <article class="api-card">
      <div class="api-card-header">
        <div class="api-card-logo" style="background:${api.logoBg};display:flex;align-items:center;justify-content:center"><i data-lucide="${api.logo}" style="width:24px;height:24px"></i></div>
        <div>
          <div class="api-card-title">${api.name} ${(api.badges || []).map(b => `<span class="api-badge ${b}">${b==='popular'?'Populaire':b==='free'?'Gratuit':''}</span>`).join('')}</div>
          <div class="api-card-provider">${api.provider}</div>
        </div>
      </div>
      <div class="api-card-desc">${api.desc}</div>
      <div class="api-card-models">
        <div class="api-models-legend">Modèle · Input / Output (par M tokens)</div>
        ${api.models.map(m => `
          <div class="api-model-row">
            <span class="api-model-name">${m.name}</span>
            <span class="api-model-price">${m.in} / ${m.out}</span>
          </div>
        `).join('')}
      </div>
      <div class="api-card-meta">${api.meta}</div>
      <div class="api-card-strengths"><strong>Idéal pour :</strong> ${api.strengths}</div>
      <a href="${api.link}" target="_blank" rel="noopener" class="api-card-link">Documentation officielle</a>
    </article>
  `).join('');
}

function renderGlossary() {
  const grid = document.getElementById('glossary-grid');
  if (!grid) return;
  grid.dataset.all = JSON.stringify(GLOSSARY);
  filterGlossary();
}
function filterGlossary() {
  const grid = document.getElementById('glossary-grid');
  const q = (document.getElementById('gloss-search')?.value || '').toLowerCase();
  const list = JSON.parse(grid?.dataset?.all || '[]');
  const filtered = q ? list.filter(g => g.term.toLowerCase().includes(q) || g.def.toLowerCase().includes(q)) : list;
  grid.innerHTML = filtered.map(g => `
    <div class="glossary-item"><div class="glossary-term">${g.term}</div><div class="glossary-def">${g.def}</div></div>
  `).join('');
}
function renderBonnesPratiques() {
  const el = document.getElementById('bonnes-pratiques-content');
  if (el) el.innerHTML = BONNES_PRATIQUES;
}
function renderGuideBuilder() {
  const el = document.getElementById('guide-builder-content');
  if (el) el.innerHTML = GUIDE_BUILDER;
}
function renderRessources() {
  const el = document.getElementById('ressources-content');
  if (!el) return;
  el.innerHTML = RESOURCES.map(r => `
    <div class="resource-card"><div><a href="${r.url}" target="_blank" rel="noopener">${r.title}</a><p style="margin:0.3rem 0 0;font-size:0.8rem">${r.desc}</p></div></div>
  `).join('');
}

let library = [];
const LIB_KEY = 'promptforge-library';
function loadLibrary() { try { library = JSON.parse(localStorage.getItem(LIB_KEY) || '[]'); } catch(e) { library = []; } }
function saveLibrary() { localStorage.setItem(LIB_KEY, JSON.stringify(library)); }
function saveToLibrary() {
  const prompt = document.getElementById('prompt-output')?.textContent?.trim() || buildPromptText();
  if (!prompt || prompt.includes('apparaîtra')) { showToast('Génère ou remplis d\'abord un prompt', true); return; }
  loadLibrary();
  const name = prompt.substring(0, 50) + (prompt.length > 50 ? '…' : '');
  library.unshift({ id: Date.now(), prompt, name, favorite: false, date: new Date().toISOString() });
  if (library.length > 100) library.pop();
  saveLibrary();
  renderLibrary();
  showToast('Sauvegardé dans la bibliothèque');
}
function toggleFavorite(id) {
  loadLibrary();
  const i = library.findIndex(x => x.id === id);
  if (i >= 0) { library[i].favorite = !library[i].favorite; saveLibrary(); renderLibrary(); }
}
function loadFromLibrary(id) {
  loadLibrary();
  const item = library.find(x => x.id === id);
  if (item) {
    document.getElementById('prompt-output').innerHTML = '';
    document.getElementById('prompt-output').textContent = item.prompt;
    updateOutputCharCount(item.prompt);
    document.getElementById('output-panel').style.display = 'block';
    document.getElementById('ab-a').textContent = item.prompt;
    navTo('builder');
  }
}
function deleteFromLibrary(id) { loadLibrary(); library = library.filter(x => x.id !== id); saveLibrary(); renderLibrary(); }
function filterLibrary() {
  const q = (document.getElementById('lib-search')?.value || '').toLowerCase();
  loadLibrary();
  const filtered = q ? library.filter(x => x.prompt.toLowerCase().includes(q) || (x.name||'').toLowerCase().includes(q)) : library;
  const list = document.getElementById('lib-list');
  list.innerHTML = filtered.length ? filtered.map(x => `
    <div class="lib-item">
      <span class="lib-item-preview" title="${(x.prompt||'').substring(0,200)}">${(x.name||x.prompt).substring(0,60)}…</span>
      <div class="lib-item-actions">
        <button class="${x.favorite?'lib-star':''}" onclick="toggleFavorite(${x.id})" title="Favori"><i data-lucide="star" style="width:14px;height:14px"></i></button>
        <button onclick="loadFromLibrary(${x.id})" title="Charger"><i data-lucide="arrow-up-right" style="width:14px;height:14px"></i></button>
        <button onclick="copyLibPrompt(${x.id});showToast('Copié')" title="Copier"><i data-lucide="copy" style="width:14px;height:14px"></i></button>
        <button onclick="deleteFromLibrary(${x.id})" title="Supprimer"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>
      </div>
    </div>
  `).join('') : '<div style="font-size:0.9rem;color:var(--muted);padding:1.5rem 1.5rem;line-height:1.6">Aucun prompt sauvegardé. Utilise "Sauvegarder" après avoir généré un prompt.</div>';
}
function copyLibPrompt(id) { const x = library.find(i=>i.id===id); if(x) navigator.clipboard.writeText(x.prompt); }
function renderLibrary() { filterLibrary(); if (typeof lucide !== 'undefined') lucide.createIcons(); }
function exportLibrary() {
  loadLibrary();
  const blob = new Blob([JSON.stringify(library, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'promptforge-library.json'; a.click(); URL.revokeObjectURL(a.href);
  showToast('Export téléchargé');
}
function importLibrary(ev) {
  const f = ev.target.files[0]; if (!f) return;
  const r = new FileReader(); r.onload = () => { try { const data = JSON.parse(r.result); loadLibrary(); library = Array.isArray(data) ? [...library, ...data] : [...library, data]; saveLibrary(); renderLibrary(); showToast('Importé'); } catch(e) { showToast('Fichier invalide', true); } ev.target.value = ''; }; r.readAsText(f);
}

function setupCatTabs() {
  document.querySelectorAll('.cat-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.cat-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentCat = btn.dataset.cat;
      renderTemplates();
    });
  });
}

function setupTabs() {
  document.querySelectorAll('.tabs').forEach(tabGroup => {
    const container = tabGroup.closest('.panel-body') || tabGroup.parentElement;
    tabGroup.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        tabGroup.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const id = tab.dataset.tab;
        if (id && container) {
          container.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          const panel = document.getElementById(id);
          if (panel) panel.classList.add('active');
        }
      });
    });
  });
}

function setupSearch() {
  document.getElementById('tpl-search').addEventListener('input', renderTemplates);
}

function setupCharCounters() {
  [['f-context','cc-context',500],['f-task','cc-task',1000]].forEach(([id,cc,max]) => {
    document.getElementById(id).addEventListener('input', e => {
      document.getElementById(cc).textContent = `${e.target.value.length} / ${max}`;
    });
  });
}

// ── TEMPLATES ──
function getPinnedTemplates() { try { return JSON.parse(localStorage.getItem(PINNED_KEY) || '[]'); } catch(e) { return []; } }
function togglePinTemplate(id, e) { e.stopPropagation(); const p = getPinnedTemplates(); const i = p.indexOf(id); if (i >= 0) p.splice(i,1); else p.push(id); localStorage.setItem(PINNED_KEY, JSON.stringify(p)); renderTemplates(); }

function renderTemplates() {
  const q = document.getElementById('tpl-search').value.toLowerCase();
  const pinned = getPinnedTemplates();
  const filtered = TEMPLATES.filter(t => {
    const matchCat = currentCat === 'all' || t.cat === currentCat;
    const matchQ   = !q || t.name.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q);
    return matchCat && matchQ;
  }).sort((a,b) => { const pa = pinned.indexOf(a.id) >= 0; const pb = pinned.indexOf(b.id) >= 0; if (pa && !pb) return -1; if (!pa && pb) return 1; return 0; });
  document.getElementById('tpl-count').textContent = `${filtered.length} templates`;
  const list = document.getElementById('tpl-list');
  list.innerHTML = filtered.length ? filtered.map(t => {
    const isPinned = pinned.indexOf(t.id) >= 0;
    return `
    <div class="tpl-card" data-id="${t.id}" onclick="loadTemplate(${t.id})">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div class="tpl-name">${t.name}</div>
        <button onclick="togglePinTemplate(${t.id},event)" title="${isPinned?'Désépingler':'Épingler'}" style="background:none;border:none;padding:0.2rem;cursor:pointer;opacity:${isPinned?1:0.5}"><i data-lucide="pin" class="icon icon-sm" style="transform:rotate(${isPinned?-45:0}deg)"></i></button>
      </div>
      <div class="tpl-desc">${t.desc}</div>
      <span class="tpl-tag" style="background:${t.color}22;color:${t.color};border:1px solid ${t.color}44">${t.tag}</span>
    </div>
  `; }).join('') : '<div style="font-size:0.75rem;color:var(--muted);text-align:center;padding:1rem">Aucun template trouvé</div>';
}

function loadTemplate(id) {
  const t = TEMPLATES.find(x => x.id === id);
  if (!t) return;
  document.getElementById('f-role').value        = t.role;
  document.getElementById('f-goal').value        = t.goal;
  document.getElementById('f-context').value     = t.context;
  document.getElementById('f-task').value        = t.task;
  document.getElementById('f-format').value      = t.format || '';
  document.getElementById('f-tone').value        = t.tone || '';
  const flang = document.getElementById('f-lang'); if (flang) flang.value = '';
  document.getElementById('f-example').value     = t.example;
  document.getElementById('f-constraints').value = t.constraints;
  // Chips
  document.querySelectorAll('.chip').forEach(c => {
    const key = c.dataset.chip || c.textContent.trim();
    c.classList.toggle('active', t.chips.includes(key));
  });
  document.querySelectorAll('.tpl-card').forEach(c => c.classList.remove('active'));
  const card = document.querySelector(`.tpl-card[data-id="${t.id}"]`);
  if (card) card.classList.add('active');
  liveScore();
}

// ── CHIPS ──
function toggleChip(el) { el.classList.toggle('active'); liveScore(); }

// ── LENGTH ──
function updateLength(el) {
  document.getElementById('length-label').textContent = LENGTH_LABELS[el.value - 1];
}

// ── LIVE SCORE (no API) ──
let scoreTimeout;
function liveScore() {
  clearTimeout(scoreTimeout);
  scoreTimeout = setTimeout(() => {
    const s = computeLocalScore();
    const badge = document.getElementById('live-score-badge');
    const color = s.global >= 80 ? 'var(--success)' : s.global >= 50 ? 'var(--warn)' : 'var(--danger)';
    badge.innerHTML = `<span style="color:${color};font-weight:700">${s.global}/100</span> qualité estimée`;
    showScorePanel(s);
  }, 300);
}

function computeLocalScore() {
  const role  = document.getElementById('f-role').value.trim();
  const goal  = document.getElementById('f-goal').value.trim();
  const ctx   = document.getElementById('f-context').value.trim();
  const task  = document.getElementById('f-task').value.trim();
  const fmt   = document.getElementById('f-format').value;
  const tone  = document.getElementById('f-tone').value;
  const ex    = document.getElementById('f-example').value.trim();
  const cons  = document.getElementById('f-constraints').value.trim();
  const chips = [...document.querySelectorAll('.chip.active')];

  // Fields score
  const fields = [role,goal,task,ctx,fmt,tone,ex,cons];
  const filled  = fields.filter(Boolean).length;
  const fieldsPct = Math.round(filled / fields.length * 100);

  // Context richness
  const totalChars = (role+goal+ctx+task+ex+cons).length;
  const ctxPct = Math.min(100, Math.round(totalChars / 8));

  // Tech
  const techPct = Math.min(100, chips.length * 25);

  // Sub-scores
  const clarity     = Math.min(100, Math.round((role.length > 20 ? 30 : 10) + (goal.length > 20 ? 30 : 10) + (task.length > 30 ? 40 : 20)));
  const structure   = Math.min(100, Math.round(fieldsPct * 0.6 + techPct * 0.4));
  const specificity = Math.min(100, Math.round(ctxPct * 0.5 + (ex ? 30 : 0) + (cons ? 20 : 0)));
  const global      = Math.min(100, Math.round(clarity * 0.3 + structure * 0.35 + specificity * 0.35));

  // Feedback
  const feedback = [];
  if (!role) feedback.push({ type:'bad', text:'Aucun rôle défini — l\'IA ne sait pas depuis quelle perspective répondre.' });
  else if (role.length < 20) feedback.push({ type:'warn', text:'Rôle trop vague. Ajoute l\'expérience, le domaine ou la spécialisation.' });
  else feedback.push({ type:'ok', text:'Rôle bien défini ✓' });

  if (!task) feedback.push({ type:'bad', text:'La tâche est vide — champ obligatoire.' });
  else if (task.length < 50) feedback.push({ type:'warn', text:'Tâche trop courte. Détaille les étapes attendues.' });
  else feedback.push({ type:'ok', text:'Tâche détaillée ✓' });

  if (!fmt) feedback.push({ type:'warn', text:'Pas de format de sortie défini. L\'IA choisira elle-même — résultats incohérents.' });
  else feedback.push({ type:'ok', text:`Format de sortie défini : ${fmt.substring(0,30)}… ✓` });

  if (!ex) feedback.push({ type:'warn', text:'Ajouter un exemple améliore significativement la qualité de la réponse.' });
  if (chips.length === 0) feedback.push({ type:'warn', text:'Aucune technique avancée activée. Essaie "Chain of Thought" pour les tâches complexes.' });
  if (chips.length >= 2) feedback.push({ type:'ok', text:`${chips.length} techniques avancées actives ✓` });

  return { global, clarity, structure, specificity, fieldsPct, ctxPct, techPct, feedback };
}

function showScorePanel(s) {
  document.getElementById('score-panel').style.display = 'block';
  setRing('ring-global',    'num-global',    s.global);
  setRing('ring-clarity',   'num-clarity',   s.clarity);
  setRing('ring-structure', 'num-structure', s.structure);
  setRing('ring-specificity','num-specificity',s.specificity);

  setBar('bar-fields', 'bar-fields-val', s.fieldsPct);
  setBar('bar-context','bar-context-val', s.ctxPct);
  setBar('bar-tech',   'bar-tech-val',    s.techPct);

  const list = document.getElementById('feedback-list');
  list.innerHTML = s.feedback.map(f => `
    <div class="fb-item fb-${f.type}">
      <span class="fb-icon">${f.type==='ok'?'✓':f.type==='warn'?'⚠':'✗'}</span>
      <span>${f.text}</span>
    </div>
  `).join('');
}

function setRing(id, numId, val) {
  const circ = 150.8;
  const el = document.getElementById(id);
  el.style.strokeDasharray = `${(val/100)*circ} ${circ}`;
  document.getElementById(numId).textContent = val;
}

function setBar(id, valId, pct) {
  document.getElementById(id).style.width    = pct + '%';
  document.getElementById(valId).textContent = pct + '%';
}

// ── BUILD PROMPT TEXT ──
function getMissingVariables() {
  const fullText = [ 'f-role','f-goal','f-context','f-task','f-example','f-constraints' ]
    .map(id => document.getElementById(id)?.value || '').join(' ');
  const vars = parseVariables();
  const matches = fullText.match(/\{\{(\w+)\}\}/g) || [];
  const missing = [...new Set(matches.map(m => m.slice(2,-2)))].filter(k => !vars[k]);
  return missing;
}

function buildPromptText() {
  const v = id => document.getElementById(id)?.value?.trim() || '';
  const vars = parseVariables();
  const apply = t => applyVariables(t, vars);
  const lang = v('f-lang');
  let role  = apply(v('f-role'));
  let goal  = apply(v('f-goal'));
  let ctx   = apply(v('f-context'));
  let task  = apply(v('f-task'));
  const fmt   = v('f-format');
  const tone  = v('f-tone');
  let ex    = apply(v('f-example'));
  let cons  = apply(v('f-constraints'));
  const chips = [...document.querySelectorAll('.chip.active')].map(c => c.dataset.val);
  const length= LENGTH_LABELS[(document.getElementById('f-length')?.value || 3) - 1];

  let prompt = '';
  if (role)  prompt += `## Rôle\nTu es ${role}.\n\n`;
  if (goal)  prompt += `## Objectif\n${goal}\n\n`;
  if (ctx)   prompt += `## Contexte\n${ctx}\n\n`;
  if (task)  prompt += `## Tâche\n${task}\n\n`;
  if (fmt)   prompt += `## Format de sortie\nRéponds en ${fmt}.\n\n`;
  if (tone)  prompt += `## Style\nAdopte un style ${tone}.\n\n`;
  if (length) prompt += `## Longueur\nLa réponse doit être : ${length}.\n\n`;
  if (ex)    prompt += `## Exemple\n${ex}\n\n`;
  if (cons)  prompt += `## Contraintes\n${cons}\n\n`;
  if (chips.length > 0) prompt += `## Instructions supplémentaires\n${chips.map(c=>`- ${c}`).join('\n')}\n`;
  if (lang) prompt += `## Langue\nRéponds en ${lang==='fr'?'français':lang==='en'?'anglais':lang==='es'?'espagnol':lang==='de'?'allemand':lang}.\n`;

  return prompt.trim();
}

// ── GENERATE ──
async function generatePrompt() {
  if (generating) return;
  const role = document.getElementById('f-role').value.trim();
  const goal = document.getElementById('f-goal').value.trim();
  const task = document.getElementById('f-task').value.trim();
  if (!role || !goal || !task) {
    showToast('Remplis au moins : Rôle, Objectif et Tâche', true); return;
  }
  const missing = getMissingVariables();
  if (missing.length > 0) {
    showToast(`Variables non définies : {{${missing.join('}}, {{')}}} — remplis le champ Variables dynamiques`, true);
    return;
  }

  generating = true;
  setGenLoading(true);
  const outPanel = document.getElementById('output-panel');
  outPanel.style.display = 'block';
  outPanel.scrollIntoView({ behavior:'smooth', block:'start' });

  const promptText = buildPromptText();
  const output = document.getElementById('prompt-output');
  output.innerHTML = '<span class="cursor"></span>';
  output.classList.add('streaming');

  // Display the built prompt immediately
  output.textContent = promptText;
  updateOutputCharCount(promptText);
  document.getElementById('ab-a').textContent = promptText;

  // Now call Claude to analyze it
  await analyzeWithClaude(promptText);

  output.classList.remove('streaming');
  addToHistory(promptText, computeLocalScore().global);
  setGenLoading(false);
  generating = false;
  document.getElementById('feedback-btns').style.display = 'flex';
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

async function analyzeWithClaude(promptText) {
  const analysisEl = document.getElementById('analysis-output');
  analysisEl.innerHTML = '<span class="cursor"></span>';

  const systemPrompt = `Tu es un expert en prompt engineering avec une profonde connaissance des LLMs (GPT-4, Claude, Gemini). 
Tu analyses des prompts et donnes des retours constructifs et précis.
Réponds TOUJOURS en français.`;

  const userMsg = `Analyse ce prompt IA et donne un retour structuré en français :

---
${promptText}
---

Fournis :
1. **Points forts** (ce qui est bien fait)
2. **Points d'amélioration** (ce qui manque ou pourrait être mieux)
3. **Score global estimé** /100 avec justification
4. **1 conseil prioritaire** pour améliorer immédiatement ce prompt

Sois précis, concret et actionnable. Max 300 mots.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: getAnthropicHeaders(),
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: 'user', content: userMsg }]
      })
    });
    const data = await response.json();
    if (!response.ok) {
      analysisEl.textContent = data.error?.message || "Erreur API. Vérifie ta clé dans Paramètres.";
      return;
    }
    const text = data.content?.[0]?.text || "Analyse non disponible.";
    analysisEl.textContent = text;
  } catch(e) {
    analysisEl.textContent = "⚠️ Analyse IA non disponible. Configure ta clé API Anthropic dans Paramètres.";
  }
}

async function generateVariantB() {
  const promptA = document.getElementById('prompt-output').textContent || document.getElementById('ab-a').textContent;
  if (!promptA || promptA.includes('apparaîtra')) { showToast('Génère d\'abord un prompt', true); return; }
  const el = document.getElementById('ab-b');
  el.textContent = 'Génération…';
  try {
    const r = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST', headers:getAnthropicHeaders(),
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514', max_tokens:2000,
        system:'Tu réécris des prompts en gardant le même objectif mais en variant la structure, les formulations ou l\'approche. Donne UNIQUEMENT le prompt réécrit, sans explication.',
        messages:[{role:'user',content:`Réécris ce prompt en variante B (même objectif, formulation différente) :\n\n---\n${promptA}\n---`}]
      })
    });
    const d = await r.json();
    el.textContent = r.ok ? (d.content?.[0]?.text || '—') : (d.error?.message || 'Erreur API');
  } catch(e) { el.textContent = '⚠️ API non disponible'; }
}

async function analyzeOnly() {
  const role = document.getElementById('f-role').value.trim();
  const goal = document.getElementById('f-goal').value.trim();
  if (!role && !goal) { showToast('Remplis au moins le Rôle et l\'Objectif', true); return; }
  liveScore();
  const s = computeLocalScore();
  showScorePanel(s);
  document.getElementById('score-panel').scrollIntoView({ behavior:'smooth' });
}

async function improvePrompt() {
  const promptText = document.getElementById('prompt-output').textContent;
  if (!promptText || promptText.includes('apparaîtra')) { showToast('Génère d\'abord un prompt', true); return; }

  const improvedEl  = document.getElementById('improved-output');
  improvedEl.textContent = '';

  // Switch to improved tab (scoped to output panel)
  document.querySelectorAll('#output-panel .tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'out-improved'));
  document.querySelectorAll('#output-panel .tab-panel').forEach(p => p.classList.toggle('active', p.id === 'out-improved'));

  const system = `Tu es un expert world-class en prompt engineering. Tu réécris des prompts pour les rendre maximalement efficaces avec les LLMs modernes. Réponds en français.`;
  const msg = `Réécris ce prompt pour le rendre 10x plus efficace. Applique toutes les meilleures pratiques : rôle précis, contexte riche, format de sortie clair, exemples si pertinent, techniques de raisonnement (CoT si nécessaire), contraintes explicites.

Prompt original :
---
${promptText}
---

Donne UNIQUEMENT le prompt réécrit et amélioré, sans explication. Commence directement.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:getAnthropicHeaders(),
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        system,
        messages: [{ role:'user', content: msg }]
      })
    });
    const data = await response.json();
    if (!response.ok) {
      improvedEl.textContent = data.error?.message || "Erreur API. Vérifie ta clé dans Paramètres.";
      return;
    }
    improvedEl.textContent = data.content?.[0]?.text || "Amélioration non disponible.";
  } catch(e) {
    improvedEl.textContent = "⚠️ Service IA non disponible. Configure ta clé API dans Paramètres.";
  }
}

// ── HISTORY ──
function addToHistory(prompt, score) {
  history.unshift({ prompt, score, date: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'}) });
  if (history.length > 10) history.pop();
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('hist-list');
  if (!history.length) { list.innerHTML = '<div style="font-size:0.75rem;color:var(--muted);text-align:center;padding:1rem">Aucun prompt généré</div>'; return; }
  list.innerHTML = history.map((h,i) => `
    <div class="hist-item" onclick="loadFromHistory(${i})">
      <div class="hist-item-top">
        <span class="hist-item-label">${h.date}</span>
        <span class="hist-item-score">${h.score}/100</span>
      </div>
      <div class="hist-item-preview">${h.prompt.substring(0,80)}…</div>
    </div>
  `).join('');
}

function loadFromHistory(i) {
  const p = history[i].prompt;
  document.getElementById('prompt-output').textContent = p;
  document.getElementById('ab-a').textContent = p;
  updateOutputCharCount(p);
  document.getElementById('output-panel').style.display = 'block';
  document.getElementById('output-panel').scrollIntoView({ behavior:'smooth' });
}

function clearHistory() { history = []; renderHistory(); }

// ── UTILS ──
function setGenLoading(on) {
  document.getElementById('gen-btn').disabled = on;
  document.getElementById('gen-icon').innerHTML = on ? '<div class="spinner"></div>' : '<i data-lucide="zap"></i>';
  document.getElementById('gen-text').textContent = on ? 'Génération…' : 'Générer le prompt';
}

function copyOutput(id) {
  const text = document.getElementById(id).textContent || document.getElementById(id).innerText;
  navigator.clipboard.writeText(text).then(() => showToast('Copié dans le presse-papier'));
}

function downloadPromptTxt() {
  const text = document.getElementById('prompt-output')?.textContent || buildPromptText();
  if (!text || text.includes('apparaîtra')) { showToast('Génère d\'abord un prompt', true); return; }
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'prompt.txt'; a.click(); URL.revokeObjectURL(a.href);
  showToast('Téléchargement démarré');
}

function sharePromptLink() {
  const text = document.getElementById('prompt-output')?.textContent || buildPromptText();
  if (!text || text.includes('apparaîtra')) { showToast('Génère d\'abord un prompt', true); return; }
  const enc = btoa(unescape(encodeURIComponent(text)));
  const url = location.origin + location.pathname + '#prompt=' + enc;
  navigator.clipboard.writeText(url).then(() => showToast('Lien copié — partage-le pour charger le prompt'));
}

function showPreview() {
  const text = buildPromptText();
  if (!text || text.trim().length < 5) { showToast('Remplis au moins un champ pour prévisualiser', true); return; }
  document.getElementById('preview-content').textContent = text;
  document.getElementById('preview-modal').classList.add('show');
  if (typeof lucide !== 'undefined') lucide.createIcons();
}
function hidePreview() { document.getElementById('preview-modal').classList.remove('show'); }

function showSettingsModal() {
  document.getElementById('api-key-input').value = getApiKey();
  document.getElementById('settings-modal').classList.add('show');
  if (typeof lucide !== 'undefined') lucide.createIcons();
}
function hideSettingsModal() { document.getElementById('settings-modal').classList.remove('show'); }
function showImportPromptModal() {
  document.getElementById('import-prompt-textarea').value = '';
  document.getElementById('import-prompt-modal').classList.add('show');
  setTimeout(() => document.getElementById('import-prompt-textarea').focus(), 100);
  if (typeof lucide !== 'undefined') lucide.createIcons();
}
function hideImportPromptModal() { document.getElementById('import-prompt-modal').classList.remove('show'); }
function confirmImportPrompt() {
  const text = document.getElementById('import-prompt-textarea').value.trim();
  if (!text) { showToast('Colle d\'abord un prompt', true); return; }
  hideImportPromptModal();
  document.getElementById('output-panel').style.display = 'block';
  document.querySelector('.tab[data-tab="out-prompt"]')?.click();
  document.getElementById('prompt-output').textContent = text;
  updateOutputCharCount(text);
  document.getElementById('ab-a').textContent = text;
  document.getElementById('output-panel').scrollIntoView({ behavior:'smooth' });
  showToast('Prompt importé — tu peux l\'analyser ou l\'améliorer');
  if (typeof lucide !== 'undefined') lucide.createIcons();
}
function updateOutputCharCount(text) {
  const el = document.getElementById('prompt-char-count');
  if (!el) return;
  const chars = (text || '').length;
  const tokens = Math.ceil(chars / 4);
  el.textContent = `${chars} caractères · ~${tokens} tokens`;
}
function saveApiKey() {
  const val = document.getElementById('api-key-input').value.trim();
  localStorage.setItem(API_KEY_KEY, val);
}

function toggleDarkMode() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? '' : 'dark');
  localStorage.setItem(THEME_KEY, isDark ? '' : 'dark');
  const icon = document.getElementById('theme-icon');
  if (icon) { icon.setAttribute('data-lucide', isDark ? 'moon' : 'sun'); if (typeof lucide !== 'undefined') lucide.createIcons(); }
}

function dismissOnboarding() {
  localStorage.setItem(ONBOARDING_KEY, '1');
  document.getElementById('onboarding-overlay').classList.remove('show');
}

function sendFeedback(v) {
  showToast(v > 0 ? 'Merci pour ton retour !' : 'On s\'améliore.');
  document.getElementById('feedback-btns').style.display = 'none';
}

function showToast(msg, warn=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.color = warn ? 'var(--warn)' : 'var(--accent2)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function resetForm() {
  ['f-role','f-goal','f-context','f-task','f-example','f-constraints','f-vars','f-lang'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
  document.getElementById('f-format').value = '';
  document.getElementById('f-tone').value   = '';
  document.getElementById('f-length').value = 3;
  document.getElementById('length-label').textContent = LENGTH_LABELS[2];
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tpl-card').forEach(c => c.classList.remove('active'));
  document.getElementById('live-score-badge').innerHTML = '';
  document.getElementById('score-panel').style.display  = 'none';
  document.getElementById('output-panel').style.display = 'none';
}

document.addEventListener('click', e => { if (!e.target.closest('.dropdown-nav')) document.getElementById('dropdown-nav')?.classList.remove('open'); });

document.addEventListener('keydown', e => {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'Enter') { e.preventDefault(); generatePrompt(); }
    if (e.key === 's') { e.preventDefault(); if (document.getElementById('output-panel')?.style?.display !== 'none') saveToLibrary(); else showToast('Génère d\'abord un prompt'); }
  }
});

function loadFromHash() {
  const hash = location.hash || '';
  const m = hash.match(/#prompt=([A-Za-z0-9+/=]+)/);
  if (m) {
    try {
      const text = decodeURIComponent(escape(atob(m[1])));
      navTo('builder');
      document.getElementById('prompt-output').textContent = text;
      document.getElementById('output-panel').style.display = 'block';
      document.getElementById('ab-a').textContent = text;
      updateOutputCharCount(text);
    } catch(e) {}
  }
}

init();
if (!localStorage.getItem(ONBOARDING_KEY)) setTimeout(() => document.getElementById('onboarding-overlay').classList.add('show'), 500);
if (localStorage.getItem(THEME_KEY) === 'dark') { document.documentElement.setAttribute('data-theme','dark'); const ic = document.getElementById('theme-icon'); if(ic) ic.setAttribute('data-lucide','sun'); if (typeof lucide !== 'undefined') lucide.createIcons(); }
loadFromHash();
</script>
</body>
</html>
